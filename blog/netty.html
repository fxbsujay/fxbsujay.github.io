<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty 源码分析 - Sujay</title>
    <meta name="description" content="Sujay Blog.">
    <link rel="preload stylesheet" href="/assets/style.24f015e4.css" as="style">
    
    <script type="module" src="/assets/app.fa9b4eef.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.4cf23e62.js">
    <link rel="modulepreload" href="/assets/chunks/theme.0be83c97.js">
    <link rel="modulepreload" href="/assets/blog_netty.md.90136efb.lean.js">
    <link rel="icon" href="/favicon.ico">
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1919c326><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-1919c326 data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="/favicon.ico" alt data-v-8426fc1a><!--]--><!--[-->Fan Xuebin<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/blog/jdk_support.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>博客</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/components/button.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>UI组件库</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-f6a63727><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-f6a63727 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/fxbsujay" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/fxbsujay" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-1919c326 data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>目录</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>返回</button><!----></div></div><aside class="VPSidebar" data-v-1919c326 data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>后端知识库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/jdk_support.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>JAVA JDK17 新特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/bit_operation.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>位运算</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/redis.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Redis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/docker.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Docker</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mysql.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MySql</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mysql_index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MySql 索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/juc.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java JUC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mq.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>消息队列</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/elk.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>ELK 学习文档</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/netty.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Netty 源码分析</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/snow-flake.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>雪花算法</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mymap.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>实现一个简易Map</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/shiwu.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Seata 分布式事务</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>前端知识库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/css.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>css选择器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/eventLoop.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>事件循环</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/vue.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Vue3 快速上手</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>生活小工具</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/hexo.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>使用 Hexo 搭建一个博客</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/text.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>示例</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1919c326 data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>大纲</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _blog_netty" data-v-6b87e69f><div><h1 id="netty-源码分析" tabindex="-1">Netty 源码分析 <a class="header-anchor" href="#netty-源码分析" aria-label="Permalink to &quot;Netty 源码分析&quot;">​</a></h1><h2 id="netty启动流程" tabindex="-1">Netty启动流程 <a class="header-anchor" href="#netty启动流程" aria-label="Permalink to &quot;Netty启动流程&quot;">​</a></h2><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// netty 中使用 NioEventLoopGroup （简称 nio boss 线程）来封装线程和 selector</span></span>
<span class="line"><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">Selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">open</span><span style="color:#002339;">(); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 创建 NioServerSocketChannel，同时会初始化它关联的 handler，以及为原生ssc存储config</span></span>
<span class="line"><span style="color:#0991B6;">NioServerSocketChannel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">attachment</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">NioServerSocketChannel</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 创建 NioServerSocketChannel 时，创建了 java 原生的 ServerSocketChannel</span></span>
<span class="line"><span style="color:#0991B6;">ServerSocketChannel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">serverSocketChannel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ServerSocketChannel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">open</span><span style="color:#002339;">(); </span></span>
<span class="line"><span style="color:#2F86D2;">serverSocketChannel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">configureBlocking</span><span style="color:#002339;">(</span><span style="color:#174781;">false</span><span style="color:#002339;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 启动 nio boss 线程执行接下来的操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">//注册（仅关联 selector 和 NioServerSocketChannel），未关注事件</span></span>
<span class="line"><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">serverSocketChannel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(selector, </span><span style="color:#174781;">0</span><span style="color:#002339;">, attachment);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// head -&gt; 初始化器 -&gt; ServerBootstrapAcceptor -&gt; tail</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 初始化器是一次性的，只为添加 acceptor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 绑定端口</span></span>
<span class="line"><span style="color:#2F86D2;">serverSocketChannel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">InetSocketAddress</span><span style="color:#002339;">(</span><span style="color:#174781;">8080</span><span style="color:#002339;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 触发 channel active 事件，在 head 中关注 op_accept 事件</span></span>
<span class="line"><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_ACCEPT</span><span style="color:#002339;">);</span></span></code></pre></div><ul><li>获得选择器Selector，Netty中使用 NioEventloopGroup 中的 NioEventloop 封装了线程和选择器</li><li>创建 NioServerSocketChannel，该Channel作为附件添加到 ServerSocketChannel 中</li><li>创建 ServerSocketChannel，将其设置为非阻塞模式，并注册到Selector中，<code>此时未关注事件，但是添加了附件NioServerSocketChannel</code></li><li>绑定端口</li><li>通过 interestOps 设置感兴趣的事件</li></ul><hr><p>选择器Selector的创建是在NioEventloopGroup中完成的。NioServerSocketChannel与ServerSocketChannel的创建，ServerSocketChannel注册到Selector中以及绑定操作都是由<code>bind</code>方法完成的</p><p>所以服务器启动的入口便是<code>io.netty.bootstrap.ServerBootstrap.bind</code></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(</span><span style="color:#0991B6;">SocketAddress</span><span style="color:#002339;"> localAddress) {</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#7EB233;">validate</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doBind</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">ObjectUtil</span><span style="color:#002339;">.</span><span style="color:#7EB233;">checkNotNull</span><span style="color:#002339;">(localAddress, </span><span style="color:#A44185;">&quot;localAddress&quot;</span><span style="color:#002339;">));</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h3 id="dobind" tabindex="-1">doBind <a class="header-anchor" href="#dobind" aria-label="Permalink to &quot;doBind&quot;">​</a></h3><blockquote><p>真正完成初始化、注册以及绑定的方法是io.netty.bootstrap.AbstractBootstrap.doBind dobind方法在主线程中执行</p></blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doBind</span><span style="color:#002339;">(</span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SocketAddress</span><span style="color:#002339;"> localAddress) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 负责 NioServerSocketChannel 和 ServerSocketChannel 的创建</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// ServerSocketChannel 的注册工作</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// init由main线程完成，regisetr由NIO线程完成</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">initAndRegister</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">channel</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">cause</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> regFuture;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 因为register操作是异步的</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 所以要判断主线程执行到这里时，register操作是否已经执行完毕</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isDone</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 执行doBind0绑定操作</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">doBind0</span><span style="color:#002339;">(regFuture, channel, localAddress, promise);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> promise;</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 如果register操作还没执行完，就会到这个分支中来</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">PendingRegistrationPromise</span><span style="color:#002339;"> promise</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">PendingRegistrationPromise</span><span style="color:#002339;">(channel);</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 添加监听器，NIO线程异步进行doBind0操作</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">addListener</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelFutureListener</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">            @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">operationComplete</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#B1108E;">future</span><span style="color:#002339;">) </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Exception</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">cause</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">future</span><span style="color:#002339;">.</span><span style="color:#7EB233;">cause</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (cause </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">promise</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setFailure</span><span style="color:#002339;">(cause);</span></span>
<span class="line"><span style="color:#002339;">                } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">promise</span><span style="color:#002339;">.</span><span style="color:#7EB233;">registered</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7EB233;">doBind0</span><span style="color:#002339;">(regFuture, channel, localAddress, promise);</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        });</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> promise;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><ul><li>initAndRegister</li><li>doBind0则负责连接的创建工作</li></ul><h3 id="initandregisterd" tabindex="-1">initAndRegisterd <a class="header-anchor" href="#initandregisterd" aria-label="Permalink to &quot;initAndRegisterd&quot;">​</a></h3><blockquote><p>主要负责NioServerSocketChannel和ServerSocketChannel的创建（主线程中完成）与ServerSocketChannel注册（NIO线程中完成）工作</p></blockquote><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#7EB233;">initAndRegister</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        channel </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channelFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">newChannel</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">init</span><span style="color:#002339;">(channel);</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (channel </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">unsafe</span><span style="color:#002339;">().</span><span style="color:#7EB233;">closeForcibly</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">DefaultChannelPromise</span><span style="color:#002339;">(</span></span>
<span class="line"><span style="color:#002339;">                channel, </span><span style="color:#2F86D2;">GlobalEventExecutor</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">INSTANCE</span><span style="color:#002339;">).</span><span style="color:#7EB233;">setFailure</span><span style="color:#002339;">(t);</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">DefaultChannelPromise</span><span style="color:#002339;">(</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">FailedChannel</span><span style="color:#002339;">(), </span><span style="color:#2F86D2;">GlobalEventExecutor</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">INSTANCE</span><span style="color:#002339;">).</span><span style="color:#7EB233;">setFailure</span><span style="color:#002339;">(t);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">config</span><span style="color:#002339;">().</span><span style="color:#7EB233;">group</span><span style="color:#002339;">().</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(channel);</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">cause</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isRegistered</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">unsafe</span><span style="color:#002339;">().</span><span style="color:#7EB233;">closeForcibly</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> regFuture;</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h4 id="初始化" tabindex="-1">初始化 <a class="header-anchor" href="#初始化" aria-label="Permalink to &quot;初始化&quot;">​</a></h4><p>init(channel) 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 通过反射初始化 NioServerSocketChannel</span></span>
<span class="line"><span style="color:#002339;">    channel </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channelFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">newChannel</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">init</span><span style="color:#002339;">(channel);</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>newChannel() 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">T</span><span style="color:#002339;"> </span><span style="color:#7EB233;">newChannel</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 通过反射调用 NioServerSocketChannel 的构造方法</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 创建 NioServerSocketChannel 对象</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">constructor</span><span style="color:#002339;">.</span><span style="color:#7EB233;">newInstance</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">throw</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelException</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">constructor</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getDeclaringClass</span><span style="color:#002339;">(), t)</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>NioServerSocketChannel() 构造方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#7EB233;">NioServerSocketChannel</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 创建了ServerSocketChannel实例</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#000000;">this</span><span style="color:#002339;">(</span><span style="color:#7EB233;">newSocket</span><span style="color:#002339;">(DEFAULT_SELECTOR_PROVIDER));</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>newSocket() 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#DA5221;">static</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ServerSocketChannel</span><span style="color:#002339;"> </span><span style="color:#7EB233;">newSocket</span><span style="color:#002339;">(</span><span style="color:#0991B6;">SelectorProvider</span><span style="color:#002339;"> provider) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// ServerSocketChannel.open 方法：</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// SelectorProvider.provider().openServerSocketChannel()</span></span>
<span class="line"><span style="color:#002339;">	    </span><span style="color:#357B42;font-style:italic;">// 所以此处相当于 ServerSocketChannel.open()</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 创建了 ServerSocketChannel 实例</span></span>
<span class="line"><span style="color:#002339;">    	</span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">provider</span><span style="color:#002339;">.</span><span style="color:#7EB233;">openServerSocketChannel</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">	} </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">  	  </span><span style="color:#7B30D0;">throw</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelException</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;Failed to open a server socket.&quot;</span><span style="color:#002339;">, e);</span></span>
<span class="line"><span style="color:#002339;">	}</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h4 id="注册" tabindex="-1">注册 <a class="header-anchor" href="#注册" aria-label="Permalink to &quot;注册&quot;">​</a></h4><p>promise.channel().unsafe().register(this, promise) 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">register</span><span style="color:#002339;">(</span><span style="color:#0991B6;">EventLoop</span><span style="color:#002339;"> eventLoop, </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelPromise</span><span style="color:#002339;"> promise) {</span></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 获取EventLoop</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">AbstractChannel</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> eventLoop;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">   	</span><span style="color:#357B42;font-style:italic;">// 此处完成了由 主线程 到 NIO线程 的切换</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// eventLoop.inEventLoop()用于判断当前线程是否为NIO线程</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;">.</span><span style="color:#7EB233;">inEventLoop</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">register0</span><span style="color:#002339;">(promise);</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 向NIO线程中添加任务</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;">.</span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Runnable</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">                @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#357B42;font-style:italic;">// 该方法中会执行doRegister</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#357B42;font-style:italic;">// 执行真正的注册操作</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7EB233;">register0</span><span style="color:#002339;">(promise);</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            });</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">           ...</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>register0() 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">register0</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelPromise</span><span style="color:#002339;"> promise) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">       	...</span></span>
<span class="line"><span style="color:#002339;">            </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 执行真正的注册操作</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">doRegister</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        neverRegistered </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        registered </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">true</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 调用init中的initChannel方法</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">invokeHandlerAddedIfNeeded</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>doRegister() 方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doRegister</span><span style="color:#002339;">() throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selected</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (;;) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// javaChannel()即为ServerSocketChannel</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// eventLoop().unwrappedSelector()获取eventLoop中的Selector</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// this为NIOServerSocketChannel，作为附件</span></span>
<span class="line"><span style="color:#002339;">            selectionKey </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7EB233;">javaChannel</span><span style="color:#002339;">().</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(</span><span style="color:#7EB233;">eventLoop</span><span style="color:#002339;">().</span><span style="color:#7EB233;">unwrappedSelector</span><span style="color:#002339;">(), </span><span style="color:#174781;">0</span><span style="color:#002339;">, </span><span style="color:#000000;">this</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">CancelledKeyException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            ...</span></span>
<span class="line"><span style="color:#002339;">           </span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>回调 initChannel()</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">initChannel</span><span style="color:#002339;">(</span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> ch) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelPipeline</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ch</span><span style="color:#002339;">.</span><span style="color:#7EB233;">pipeline</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">ChannelHandler</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">handler</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">handler</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (handler </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">addLast</span><span style="color:#002339;">(handler);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 添加新任务，任务负责添加handler</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 该handler负责发生Accepet事件后建立连接</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">ch</span><span style="color:#002339;">.</span><span style="color:#7EB233;">eventLoop</span><span style="color:#002339;">().</span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Runnable</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">        @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">addLast</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ServerBootstrapAcceptor</span><span style="color:#002339;">(</span></span>
<span class="line"><span style="color:#002339;">                    ch, currentChildGroup, currentChildHandler,</span></span>
<span class="line"><span style="color:#002339;">                     currentChildOptions, currentChildAttrs));</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    });</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>Register主要完成了以下三个操作</p><ul><li>完成了主线程到NIO的线程切换 <ul><li>通过 <code>eventLoop.inEventLoop()</code> 进行线程判断，判断当前线程是否为NIO线程</li><li>切换的方式为让eventLoop执行register的操作</li><li>register的操作在NIO线程中完成调用doRegister方法</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// javaChannel()即为ServerSocketChannel</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// eventLoop().unwrappedSelector()获取eventLoop中的Selector</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// this为NIOServerSocketChannel，作为附件</span></span>
<span class="line"><span style="color:#002339;">selectionKey </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">javaChannel</span><span style="color:#002339;">().</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(</span><span style="color:#7EB233;">eventLoop</span><span style="color:#002339;">().</span><span style="color:#7EB233;">unwrappedSelector</span><span style="color:#002339;">(), </span><span style="color:#174781;">0</span><span style="color:#002339;">, </span><span style="color:#000000;">this</span><span style="color:#002339;">);</span></span></code></pre></div><ul><li>将ServerSocketChannel注册到EventLoop的Selector中 <ul><li>此时还未关注事件</li><li>添加NioServerSocketChannel附件</li></ul></li><li>通过invokeHandlerAddedIfNeeded调用init中的initChannel方法 <ul><li>initChannel方法主要创建了两个handler <ul><li>一个handler负责设置配置</li><li>一个handler负责发生Accept事件后建立连接</li></ul></li></ul></li></ul><h3 id="dobind0" tabindex="-1">doBind0 <a class="header-anchor" href="#dobind0" aria-label="Permalink to &quot;doBind0&quot;">​</a></h3><p>绑定端口</p><p>在 doRegister 和 invokeHandlerAddedIfNeeded 操作中的完成后，会调用 safeSetSuccess(promise) 方法，向Promise中设置执行成功的结果。此时 doBind 方法中由 initAndRegister 返回的ChannelFuture对象regFuture便会由NIO线程异步执行doBind0绑定操作</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// initAndRegister为异步方法，会返回ChannelFuture对象</span></span>
<span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">initAndRegister</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#2F86D2;">regFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">addListener</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelFutureListener</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">operationComplete</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#B1108E;">future</span><span style="color:#002339;">) </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Exception</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">cause</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">future</span><span style="color:#002339;">.</span><span style="color:#7EB233;">cause</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (cause </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// IllegalStateException once we try to access the EventLoop of the Channel.</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">promise</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setFailure</span><span style="color:#002339;">(cause);</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// Registration was successful, so set the correct executor to use.</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// See https://github.com/netty/netty/issues/2586</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">promise</span><span style="color:#002339;">.</span><span style="color:#7EB233;">registered</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 如果没有异常，则执行绑定操作</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">doBind0</span><span style="color:#002339;">(regFuture, channel, localAddress, promise);</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">});</span></span></code></pre></div><p>doBind0最底层调用的是ServerSocketChannel的bind方法</p><p>NioServerSocketChannel.doBind方法</p><p>通过该方法，绑定了对应的端口</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">SuppressJava6Requirement</span><span style="color:#002339;">(</span><span style="color:#174781;">reason</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;Usage guarded by java version check&quot;</span><span style="color:#002339;">)</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doBind</span><span style="color:#002339;">(</span><span style="color:#0991B6;">SocketAddress</span><span style="color:#002339;"> localAddress) throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">PlatformDependent</span><span style="color:#002339;">.</span><span style="color:#7EB233;">javaVersion</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">&gt;=</span><span style="color:#002339;"> </span><span style="color:#174781;">7</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 调用ServerSocketChannel的bind方法，绑定端口</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">javaChannel</span><span style="color:#002339;">().</span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(localAddress, </span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getBacklog</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">javaChannel</span><span style="color:#002339;">().</span><span style="color:#7EB233;">socket</span><span style="color:#002339;">().</span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(localAddress, </span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getBacklog</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>关注事件</p><p>在绑定端口操作完成后，会判断各种所有初始化操作是否已经完成，若完成，则会添加ServerSocketChannel感兴趣的事件<br>​<br></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">wasActive </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#7EB233;">isActive</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">invokeLater</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Runnable</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">        @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelActive</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    });</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>最终在 <code>AbstractNioChannel.doBeginRead</code> 方法中，会添加ServerSocketChannel添加Accept事件</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doBeginRead</span><span style="color:#002339;">() throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// Channel.read() or ChannelHandlerContext.read() was called</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isValid</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">    readPending </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">true</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">interestOps</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 如果ServerSocketChannel没有关注Accept事件</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((interestOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> readInterestOp) </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 则让其关注Accepet事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// readInterestOp 取值是 16</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 在 NioServerSocketChannel 创建时初始化</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">(interestOps </span><span style="color:#7B30D0;">|</span><span style="color:#002339;"> readInterestOp);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p><p>此处设置interestOps时使用的方法，避免覆盖关注的其他事件</p></div><p>首先获取Channel所有感兴趣的事件</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">interestOps</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">();</span></span></code></pre></div><p>然后再设置其感兴趣的事件</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">(interestOps </span><span style="color:#7B30D0;">|</span><span style="color:#002339;"> readInterestOp);</span></span></code></pre></div><p>各个事件对应的值</p><p><img src="/doc/netty-principle/img-0.png" alt=""></p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>通过上述步骤，完成了</p><ul><li>NioServerSocketChannel与ServerSocketChannel的创建</li><li>ServerSocketChannel绑定到EventLoop的Selecot中，并添加NioServerSocketChannel附件</li><li>绑定了对应的端口</li><li>关注了Accept事件</li></ul><h2 id="nioeventloop剖析" tabindex="-1">NioEventLoop剖析 <a class="header-anchor" href="#nioeventloop剖析" aria-label="Permalink to &quot;NioEventLoop剖析&quot;">​</a></h2><h3 id="组成" tabindex="-1">组成 <a class="header-anchor" href="#组成" aria-label="Permalink to &quot;组成&quot;">​</a></h3><p>NioEventLoop的重要组成部分有三个</p><p>Selector</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">NioEventLoop</span><span style="color:#002339;"> </span><span style="color:#DA5221;">extends</span><span style="color:#002339;"> </span><span style="color:#B02767;">SingleThreadEventLoop</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// selector中的selectedKeys是基于数组的</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// unwrappedSelector中的selectedKeys是基于HashSet的    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectedSelectionKeySet</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeys</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>Thread与TaskQueue</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">abstract</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">SingleThreadEventExecutor</span><span style="color:#002339;"> </span><span style="color:#DA5221;">extends</span><span style="color:#002339;"> </span><span style="color:#B02767;">AbstractScheduledEventExecutor</span><span style="color:#002339;"> </span><span style="color:#DA5221;">implements</span><span style="color:#002339;"> </span><span style="color:#B02767;">OrderedEventExecutor</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 任务队列</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Queue</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">Runnable</span><span style="color:#002339;">&gt; </span><span style="color:#2F86D2;">taskQueue</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 线程</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#DA5221;">volatile</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Thread</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">thread</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h4 id="selector的创建" tabindex="-1">Selector的创建 <a class="header-anchor" href="#selector的创建" aria-label="Permalink to &quot;Selector的创建&quot;">​</a></h4><p>Selector是在NioEventLoop的构造方法中被创建的</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">NioEventLoop</span><span style="color:#002339;">(</span><span style="color:#0991B6;">NioEventLoopGroup</span><span style="color:#002339;"> parent, </span><span style="color:#0991B6;">Executor</span><span style="color:#002339;"> executor, </span><span style="color:#0991B6;">SelectorProvider</span><span style="color:#002339;"> selectorProvider, </span><span style="color:#0991B6;">SelectStrategy</span><span style="color:#002339;"> strategy, </span><span style="color:#0991B6;">RejectedExecutionHandler</span><span style="color:#002339;"> rejectedExecutionHandler, </span><span style="color:#0991B6;">EventLoopTaskQueueFactory</span><span style="color:#002339;"> queueFactory) {</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">           </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 初始化selector，初始化过程在openSelector中</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectorTuple</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectorTuple</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">openSelector</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectorTuple</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectorTuple</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectorTuple</span><span style="color:#002339;"> </span><span style="color:#7EB233;">openSelector</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 此处等同于 Selector.open()方法</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 创建了unwrappedSelector对象</span></span>
<span class="line"><span style="color:#002339;">        unwrappedSelector </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">provider</span><span style="color:#002339;">.</span><span style="color:#7EB233;">openSelector</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">throw</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelException</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;failed to open a new selector&quot;</span><span style="color:#002339;">, e);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>NioEventLoop的构造方法中，调用了 openSelector() 方法， 该方法会返回一个 SelectorTuple 对象，该方法是创建 Selector 的核心方法。openSelector() 方法内部调用了</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">unwrappedSelector </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">provider</span><span style="color:#002339;">.</span><span style="color:#7EB233;">openSelector</span><span style="color:#002339;">();</span></span></code></pre></div><p>获得了 Selector 对象 unwrappedSelector</p><p>后面会通过反射，修改 unwrappedSelector中SelectedKeys 的实现，然后通过 SelectedSelectionKeySetSelector 方法获得 selector。最后通过 SelectorTuple 的构造方法，将该 Selector 的值赋给 SelectorTuple 类中的 selector 与 unwrappedSelector</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#DA5221;">static</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">SelectorTuple</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">SelectorTuple</span><span style="color:#002339;">(</span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#B1108E;">unwrappedSelector</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> unwrappedSelector;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> unwrappedSelector;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">    * 一般调用的是这个构造方法</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">    */</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">SelectorTuple</span><span style="color:#002339;">(</span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#B1108E;">unwrappedSelector</span><span style="color:#002339;">, </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#B1108E;">selector</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> unwrappedSelector;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selector</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> selector;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>再通过 NioEventLoop 的构造方法，将 SelectorTuple 中的 Selector 赋值给 NioEventLoop中的Selector</p><h4 id="两个selector" tabindex="-1">两个Selector <a class="header-anchor" href="#两个selector" aria-label="Permalink to &quot;两个Selector&quot;">​</a></h4><p>NioEventLoop中有selector和unwrappedSelector两个Selector，它们的区别主要在于SelectedKeys的数据结构</p><ul><li>selector中的SelectedKeys是基于数组的</li><li>unwrappedSelector中的是基于HashSet的</li></ul><div class="tip custom-block line"> 这样做的主要目的是，数组的遍历效率要高于HashSet </div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectorTuple</span><span style="color:#002339;"> </span><span style="color:#7EB233;">openSelector</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Selector</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">unwrappedSelector</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        unwrappedSelector </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">provider</span><span style="color:#002339;">.</span><span style="color:#7EB233;">openSelector</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">throw</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelException</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;failed to open a new selector&quot;</span><span style="color:#002339;">, e);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 获得基于数组的selectedKeySet实现</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectedSelectionKeySet</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeySet</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectedSelectionKeySet</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">maybeException</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">AccessController</span><span style="color:#002339;">.</span><span style="color:#7EB233;">doPrivileged</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">PrivilegedAction</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt;() {</span></span>
<span class="line"><span style="color:#002339;">        @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 通过反射拿到unwrappedSelector中的selectedKeys属性</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#0991B6;">Field</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeysField</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectorImplClass</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getDeclaredField</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;selectedKeys&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#0991B6;">Field</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">publicSelectedKeysField</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectorImplClass</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getDeclaredField</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;publicSelectedKeys&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">                ...</span></span>
<span class="line"><span style="color:#002339;">	</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 暴力反射，修改私有属性</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">cause</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ReflectionUtil</span><span style="color:#002339;">.</span><span style="color:#7EB233;">trySetAccessible</span><span style="color:#002339;">(selectedKeysField, </span><span style="color:#174781;">true</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (cause </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> cause;</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">                cause </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ReflectionUtil</span><span style="color:#002339;">.</span><span style="color:#7EB233;">trySetAccessible</span><span style="color:#002339;">(publicSelectedKeysField, </span><span style="color:#174781;">true</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (cause </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> cause;</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 替换为基于数组的selectedKeys实现</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">selectedKeysField</span><span style="color:#002339;">.</span><span style="color:#7EB233;">set</span><span style="color:#002339;">(unwrappedSelector, selectedKeySet);</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">publicSelectedKeysField</span><span style="color:#002339;">.</span><span style="color:#7EB233;">set</span><span style="color:#002339;">(unwrappedSelector, selectedKeySet);</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">NoSuchFieldException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> e;</span></span>
<span class="line"><span style="color:#002339;">            } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IllegalAccessException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> e;</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    selectedKeys </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> selectedKeySet;</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 调用构造函数，创建unwrappedSelector与selector</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectorTuple</span><span style="color:#002339;">(unwrappedSelector,</span></span>
<span class="line"><span style="color:#002339;">                             </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectedSelectionKeySetSelector</span><span style="color:#002339;">(unwrappedSelector, selectedKeySet));</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>获得数组实现SelectedKeys的Selector的原理是反射，主要步骤如下</p><ul><li>获得基于数组的selectedKeySet实现</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 获得基于数组的selectedKeySet实现</span></span>
<span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectedSelectionKeySet</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeySet</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectedSelectionKeySet</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7EB233;">SelectedSelectionKeySet</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">	keys </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;">[</span><span style="color:#174781;">1024</span><span style="color:#002339;">];</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><ul><li>通过反射拿到unwrappedSelector中的SelectedKeySet并将其替换为selectedKeySet</li><li>通过Selector的构造方法获得selector</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectedSelectionKeySetSelector</span><span style="color:#002339;">(unwrappedSelector, selectedKeySet)</span></span></code></pre></div><ul><li>通过SelectorTuple的构造方法获得拥有两种Selector的SelectorTuple对象，并返回给NioEventLoop</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 调用构造函数，创建unwrappedSelector与selector</span></span>
<span class="line"><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectorTuple</span><span style="color:#002339;">(unwrappedSelector, </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">SelectedSelectionKeySetSelector</span><span style="color:#002339;">(unwrappedSelector, selectedKeySet));</span></span></code></pre></div><h3 id="nio线程启动时机" tabindex="-1">NIO线程启动时机 <a class="header-anchor" href="#nio线程启动时机" aria-label="Permalink to &quot;NIO线程启动时机&quot;">​</a></h3><p>启动NioEventLoop中的线程，在首次执行任务时，才会被创建，且只会被创建一次</p><p>测试代码</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">TestNioEventLoop</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">static</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">main</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;">[] </span><span style="color:#B1108E;">args</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">EventLoop</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">NioEventLoopGroup</span><span style="color:#002339;">().</span><span style="color:#7EB233;">next</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 使用NioEventLoop执行任务</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;">.</span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(()</span><span style="color:#0991B6;">-&gt;</span><span style="color:#002339;">{</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;hello&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        });</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>进入execute执行任务</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(</span><span style="color:#0991B6;">Runnable</span><span style="color:#002339;"> task) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 检测传入的任务是否为空，为空会抛出NullPointerException</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">ObjectUtil</span><span style="color:#002339;">.</span><span style="color:#7EB233;">checkNotNull</span><span style="color:#002339;">(task, </span><span style="color:#A44185;">&quot;task&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 执行任务</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 此处判断了任务是否为懒加载任务，wakesUpForTask的返回值只会为true</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(task, </span><span style="color:#7B30D0;">!</span><span style="color:#002339;">(task </span><span style="color:#7B30D0;">instanceof</span><span style="color:#002339;"> LazyRunnable) </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#7EB233;">wakesUpForTask</span><span style="color:#002339;">(task));</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>进入上述代码的execute方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(</span><span style="color:#0991B6;">Runnable</span><span style="color:#002339;"> task, </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> immediate) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 判断当前线程是否为NIO线程</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 判断方法为 return thread == this.thread;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// this.thread即为NIO线程，首次执行任务时，其为null</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">inEventLoop</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">inEventLoop</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 向任务队列taskQueue中添加任务</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">addTask</span><span style="color:#002339;">(task);</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 当前线程不是NIO线程，则进入if语句</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">inEventLoop) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 启动NIO线程的核心方法</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">startThread</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">	</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 有任务需要被执行时，唤醒阻塞的NIO线程</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">addTaskWakesUp </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> immediate) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">wakeup</span><span style="color:#002339;">(inEventLoop);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>进入startThread方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">startThread</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 查看NIO线程状态是否为未启动</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 该if代码块只会执行一次</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// state一开始的值就是ST_NOT_STARTED</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// private volatile int state = ST_NOT_STARTED;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (state </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> ST_NOT_STARTED) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 通过原子属性更新器将状态更新为启动（ST_STARTED）</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">STATE_UPDATER</span><span style="color:#002339;">.</span><span style="color:#7EB233;">compareAndSet</span><span style="color:#002339;">(</span><span style="color:#000000;">this</span><span style="color:#002339;">, ST_NOT_STARTED, ST_STARTED)) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">success</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 执行启动线程</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7EB233;">doStartThread</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                success </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">true</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">success) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">STATE_UPDATER</span><span style="color:#002339;">.</span><span style="color:#7EB233;">compareAndSet</span><span style="color:#002339;">(</span><span style="color:#000000;">this</span><span style="color:#002339;">, ST_STARTED, ST_NOT_STARTED);</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>进入doStartThread，真正创建NIO线程并执行任务</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doStartThread</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">assert</span><span style="color:#002339;"> thread </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 创建NIO线程并执行任务</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">executor</span><span style="color:#002339;">.</span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Runnable</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">        @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// thread即为NIO线程</span></span>
<span class="line"><span style="color:#002339;">            thread </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">Thread</span><span style="color:#002339;">.</span><span style="color:#7EB233;">currentThread</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (interrupted) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">thread</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interrupt</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">success</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">updateLastExecutionTime</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 执行内部run方法</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">SingleThreadEventExecutor</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">this</span><span style="color:#002339;">.</span><span style="color:#7EB233;">run</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                success </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">true</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            } </span></span>
<span class="line"><span style="color:#002339;">            </span></span>
<span class="line"><span style="color:#002339;">            ...</span></span>
<span class="line"><span style="color:#002339;">    });</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>通过SingleThreadEventExecutor.this.run()执行传入的任务（task）</p><p>该run方法是NioEvnetLoop的run方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectCnt</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 死循环，不断地从任务队列中获取各种任务来执行</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (;;) {	</span></span>
<span class="line"><span style="color:#002339;">      	</span><span style="color:#357B42;font-style:italic;">// 执行各种任务</span></span>
<span class="line"><span style="color:#002339;">   		</span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">strategy</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                strategy </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectStrategy</span><span style="color:#002339;">.</span><span style="color:#7EB233;">calculateStrategy</span><span style="color:#002339;">(selectNowSupplier, </span><span style="color:#7EB233;">hasTasks</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">switch</span><span style="color:#002339;"> (strategy) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">case</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectStrategy</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">CONTINUE</span><span style="color:#7B30D0;">:</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7B30D0;">continue</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">case</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectStrategy</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">BUSY_WAIT</span><span style="color:#7B30D0;">:</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#357B42;font-style:italic;">// fall-through to SELECT since the busy-wait is not supported with NIO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">case</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectStrategy</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">SELECT</span><span style="color:#7B30D0;">:</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#0991B6;">long</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">curDeadlineNanos</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">nextScheduledTaskDeadlineNanos</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (curDeadlineNanos </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">-</span><span style="color:#174781;">1L</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                        curDeadlineNanos </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> NONE; </span><span style="color:#357B42;font-style:italic;">// nothing on the calendar</span></span>
<span class="line"><span style="color:#002339;">                    }</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">nextWakeupNanos</span><span style="color:#002339;">.</span><span style="color:#7EB233;">set</span><span style="color:#002339;">(curDeadlineNanos);</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#7EB233;">hasTasks</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">                            strategy </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">select</span><span style="color:#002339;">(curDeadlineNanos);</span></span>
<span class="line"><span style="color:#002339;">                        }</span></span>
<span class="line"><span style="color:#002339;">                    } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                        </span><span style="color:#357B42;font-style:italic;">// This update is just to help block unnecessary selector wakeups</span></span>
<span class="line"><span style="color:#002339;">                        </span><span style="color:#357B42;font-style:italic;">// so use of lazySet is ok (no race condition)</span></span>
<span class="line"><span style="color:#002339;">                        </span><span style="color:#2F86D2;">nextWakeupNanos</span><span style="color:#002339;">.</span><span style="color:#7EB233;">lazySet</span><span style="color:#002339;">(AWAKE);</span></span>
<span class="line"><span style="color:#002339;">                    }</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#357B42;font-style:italic;">// fall through</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">default:</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">       		}</span></span>
<span class="line"><span style="color:#002339;">    	}</span></span>
<span class="line"><span style="color:#002339;">	}</span></span></code></pre></div><h4 id="唤醒" tabindex="-1">唤醒 <a class="header-anchor" href="#唤醒" aria-label="Permalink to &quot;唤醒&quot;">​</a></h4><p>NioEvnetLoop需要IO事件、普通任务以及定时任务，任务在run方法的for循环中</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectCnt</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 死循环，不断地从任务队列中获取各种任务来执行</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (;;) {</span></span>
<span class="line"><span style="color:#002339;">      	</span><span style="color:#357B42;font-style:italic;">// 执行各种任务</span></span>
<span class="line"><span style="color:#002339;">   		...</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>中被执行，但该循环不会空转，执行到某些代码时，会被阻塞</p><p>run方法中有SELECT分支</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">case</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectStrategy</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">SELECT</span><span style="color:#7B30D0;">:</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#0991B6;">long</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">curDeadlineNanos</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">nextScheduledTaskDeadlineNanos</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (curDeadlineNanos </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">-</span><span style="color:#174781;">1L</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        curDeadlineNanos </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> NONE; </span><span style="color:#357B42;font-style:italic;">// nothing on the calendar</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#2F86D2;">nextWakeupNanos</span><span style="color:#002339;">.</span><span style="color:#7EB233;">set</span><span style="color:#002339;">(curDeadlineNanos);</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">    	</span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#7EB233;">hasTasks</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 执行select方法</span></span>
<span class="line"><span style="color:#002339;">            strategy </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">select</span><span style="color:#002339;">(curDeadlineNanos);</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span></code></pre></div><p>会执行NioEvnetLoop的select方法，该方法内部会根据情况，执行selector的有参和无参的select方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#7EB233;">select</span><span style="color:#002339;">(</span><span style="color:#0991B6;">long</span><span style="color:#002339;"> deadlineNanos) throws IOException {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 如果没有指定阻塞事件，就调用select()</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (deadlineNanos </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> NONE) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">select</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 否则调用select(timeoutMillis)，指定时间内未发生事件就停止阻塞</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// Timeout will only be 0 if deadline is within 5 microsecs</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">long</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">timeoutMillis</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">deadlineToDelayNanos</span><span style="color:#002339;">(deadlineNanos </span><span style="color:#7B30D0;">+</span><span style="color:#002339;"> </span><span style="color:#174781;">995000L</span><span style="color:#002339;">) </span><span style="color:#7B30D0;">/</span><span style="color:#002339;"> </span><span style="color:#174781;">1000000L</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> timeoutMillis </span><span style="color:#7B30D0;">&lt;=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">?</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">selectNow</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">:</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">select</span><span style="color:#002339;">(timeoutMillis);</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>但需要注意的是，select方法是会阻塞线程的，当没有IO事件，但有其他任务需要执行时，需要唤醒线程</p><p>唤醒是通过execute最后的if代码块来完成的</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 有任务需要被执行时，唤醒阻塞的NIO线程</span></span>
<span class="line"><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">addTaskWakesUp </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> immediate) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">wakeup</span><span style="color:#002339;">(inEventLoop);</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>NioEventLoop.wakeup唤醒被selector.select方法阻塞的NIO线程</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">wakeup</span><span style="color:#002339;">(</span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> inEventLoop) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 只有当其他线程给当前NIO线程提交任务时（如执行execute），才会被唤醒</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 通过AtomicLong进行更新，保证每次只能有一个线程唤醒成功</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">inEventLoop </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">nextWakeupNanos</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getAndSet</span><span style="color:#002339;">(AWAKE) </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> AWAKE) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 唤醒被selector.select方法阻塞的NIO线程</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">wakeup</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>唤醒时需要进行两个判断</p><ul><li>判断提交任务的是否为NIO线程 <ul><li>若是其他线程，才能唤醒NIO线程</li><li>若是NIO线程自己，则不能唤醒</li></ul></li><li>通过 <code>AtomicLong</code> 保证有多个线程同时提交任务时，只有一个线程能够唤醒NIO线程</li></ul><h4 id="select分支" tabindex="-1">SELECT分支 <a class="header-anchor" href="#select分支" aria-label="Permalink to &quot;SELECT分支&quot;">​</a></h4><p>run方法的switch语句有多条分支，具体执行分支的代码由strategy变量控制</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">strategy</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectStrategy</span><span style="color:#002339;">.</span><span style="color:#7EB233;">calculateStrategy</span><span style="color:#002339;">(selectNowSupplier, </span><span style="color:#7EB233;">hasTasks</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#7B30D0;">switch</span><span style="color:#002339;"> (strategy) {</span></span>
<span class="line"><span style="color:#002339;">	...</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>strategy的值由calculateStrategy方法确定</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#7EB233;">calculateStrategy</span><span style="color:#002339;">(</span><span style="color:#0991B6;">IntSupplier</span><span style="color:#002339;"> selectSupplier, </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> hasTasks) throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// selectSupplier.get() 底层是 selector.selectNow();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> hasTasks </span><span style="color:#7B30D0;">?</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectSupplier</span><span style="color:#002339;">.</span><span style="color:#7EB233;">get</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">:</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectStrategy</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">SELECT</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>该方法会根据hasTaks变量判断任务队列中是否有任务</p><ul><li>若有任务，则通过selectSupplier获得strategy的值 <ul><li>get方法会selectNow方法，顺便拿到IO事件</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">IntSupplier</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectNowSupplier</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">IntSupplier</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#7EB233;">get</span><span style="color:#002339;">() </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Exception</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">NioEventLoop</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">this</span><span style="color:#002339;">.</span><span style="color:#7EB233;">selectNow</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#7EB233;">selectNow</span><span style="color:#002339;">() throws IOException {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">selectNow</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><ul><li>没有任务，就会进入SELECT分支</li></ul><p>也就说，当任务队列中没有任务时，才会进入SELECT分支，让NIO线程阻塞，而不是空转。若有任务，则会通过get方法调用selector.selectNow方法，顺便拿到IO事件</p><h3 id="java-nio空轮询bug" tabindex="-1">Java NIO空轮询BUG <a class="header-anchor" href="#java-nio空轮询bug" aria-label="Permalink to &quot;Java NIO空轮询BUG&quot;">​</a></h3><p>Java NIO空轮询BUG也就是JavaNIO在Linux系统下的epoll空轮询问题</p><p>在NioEventLoop中，因为run方法中存在一个死循环，需要通过selector.select方法来阻塞线程。但是select方法因为BUG，可能无法阻塞线程，导致循环一直执行，使得CPU负载升高</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;">(;;){</span></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 可能发生空轮询，无法阻塞NIO线程</span></span>
<span class="line"><span style="color:#002339;">        strategy </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">select</span><span style="color:#002339;">(curDeadlineNanos);  </span></span>
<span class="line"><span style="color:#002339;">        ...     </span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">     	</span><span style="color:#7B30D0;">if</span><span style="color:#002339;">(...) {</span></span>
<span class="line"><span style="color:#002339;">			...</span></span>
<span class="line"><span style="color:#002339;">     	} </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7EB233;">unexpectedSelectorWakeup</span><span style="color:#002339;">(selectCnt) ){</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 通过unexpectedSelectorWakeup方法中的rebuildSelector重建selector</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 并将selectCnt重置为0</span></span>
<span class="line"><span style="color:#002339;">            selectCnt </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">	}</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>Netty中通过selectCnt变量来检测select方法是否发生空轮询BUG</p><p>若发生空轮询BUG，那么selectCnt的值会增长是十分迅速。当selectCnt的值大于等于SELECTOR_AUTO_REBUILD_THRESHOLD（默认512）时，Netty则判断其出现了空轮询BUG，进行如下处理</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (SELECTOR_AUTO_REBUILD_THRESHOLD </span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> selectCnt </span><span style="color:#7B30D0;">&gt;=</span><span style="color:#002339;"> SELECTOR_AUTO_REBUILD_THRESHOLD) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// The selector returned prematurely many times in a row.</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// Rebuild the selector to work around the problem.</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">logger</span><span style="color:#002339;">.</span><span style="color:#7EB233;">warn</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;Selector.select() returned prematurely {} times in a row; rebuilding Selector {}.&quot;</span><span style="color:#002339;">,selectCnt, selector);</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 重建selector，将原selector的配置信息传给新selector</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 再用新selector覆盖旧selector</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">rebuildSelector</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#174781;">true</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>通过rebuildSelector方法重建selector，将原selector的配置信息传给新selector，再用新selector覆盖旧selector。同时将selectCnt的值设置为0</p><h3 id="ioratio" tabindex="-1">ioRatio <a class="header-anchor" href="#ioratio" aria-label="Permalink to &quot;ioRatio&quot;">​</a></h3><p>NioEventLoop可以处理IO事件和其他任务。不同的操作所耗费的时间是不同的，想要控制NioEventLoop处理IO事件花费时间占执行所有操作的总时间的比例，需要通过ioRatio来控制</p><p>NioEventLoop.run方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 处理IO事件时间比例，默认为50%</span></span>
<span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ioRatio</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">ioRatio</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 如果IO事件时间比例设置为100%</span></span>
<span class="line"><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (ioRatio </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">100</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 如果需要去处理IO事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (strategy </span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 先处理IO事件</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">processSelectedKeys</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// Ensure we always run tasks.</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 剩下的时间都去处理普通任务和定时任务</span></span>
<span class="line"><span style="color:#002339;">        ranTasks </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">runAllTasks</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">} </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (strategy </span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) { </span><span style="color:#357B42;font-style:italic;">// 如果需要去处理IO事件</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 记录处理IO事件前的时间</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">long</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ioStartTime</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#7EB233;">nanoTime</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 去处理IO事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">processSelectedKeys</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// Ensure we always run tasks.</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// ioTime为处理IO事件耗费的事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">long</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ioTime</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#7EB233;">nanoTime</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">-</span><span style="color:#002339;"> ioStartTime;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 计算出处理其他任务的事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 超过设定的时间后，将会停止任务的执行，会在下一次循环中再继续执行</span></span>
<span class="line"><span style="color:#002339;">        ranTasks </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">runAllTasks</span><span style="color:#002339;">(ioTime </span><span style="color:#7B30D0;">*</span><span style="color:#002339;"> (</span><span style="color:#174781;">100</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">-</span><span style="color:#002339;"> ioRatio) </span><span style="color:#7B30D0;">/</span><span style="color:#002339;"> ioRatio);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">} </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> { </span><span style="color:#357B42;font-style:italic;">// 没有IO事件需要处理</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// This will run the minimum number of tasks</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 直接处理普通和定时任务</span></span>
<span class="line"><span style="color:#002339;">    ranTasks </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">runAllTasks</span><span style="color:#002339;">(</span><span style="color:#174781;">0</span><span style="color:#002339;">); </span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>通过ioRatio控制各个任务执行的过程如下</p><ul><li>判断ioRatio是否为100 <ul><li>若是，判断是否需要处理IO事件（strategy&gt;0） <ul><li>若需要处理IO事件，则先处理IO事件</li></ul></li><li>若否（或IO事件已经处理完毕），接下来去执行所有的普通任务和定时任务，直到所有任务都被处理完</li></ul></li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 没有指定执行任务的时间</span></span>
<span class="line"><span style="color:#002339;">ranTasks </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">runAllTasks</span><span style="color:#002339;">();</span></span></code></pre></div><p>若ioRatio不为100</p><ul><li>先去处理IO事件，记录处理IO事件所花费的事件保存在ioTime中</li><li>接下来去处理其他任务，根据ioTime与ioRatio计算执行其他任务可用的时间</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 比如ioTime为10s，ioRatio为50</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 那么通过 10*(100-50)/50=10 计算出其他任务可用的时间为 10s</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 处理IO事件占用的事件总比例为50%</span></span>
<span class="line"><span style="color:#002339;">ranTasks </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">runAllTasks</span><span style="color:#002339;">(ioTime </span><span style="color:#7B30D0;">*</span><span style="color:#002339;"> (</span><span style="color:#174781;">100</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">-</span><span style="color:#002339;"> ioRatio) </span><span style="color:#7B30D0;">/</span><span style="color:#002339;"> ioRatio);</span></span></code></pre></div><ul><li>执行其他任务一旦超过可用时间，则会停止执行，在下一次循环中再继续执行</li><li>若没有IO事件需要处理，则去执行最少数量的普通任务和定时任务</li></ul><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 运行最少数量的任务</span></span>
<span class="line"><span style="color:#002339;">ranTasks </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">runAllTasks</span><span style="color:#002339;">(</span><span style="color:#174781;">0</span><span style="color:#002339;">);</span></span></code></pre></div><h3 id="处理事件" tabindex="-1">处理事件 <a class="header-anchor" href="#处理事件" aria-label="Permalink to &quot;处理事件&quot;">​</a></h3><p>IO事件是通过NioEventLoop.processSelectedKeys()方法处理的</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">processSelectedKeys</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 如果selectedKeys是基于数组的</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 一般情况下都走这个分支</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (selectedKeys </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 处理各种IO事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">processSelectedKeysOptimized</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">processSelectedKeysPlain</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">selectedKeys</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>processSelectedKeysOptimized方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">processSelectedKeysOptimized</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">i</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">; i </span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeys</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">size</span><span style="color:#002339;">; </span><span style="color:#7B30D0;">++</span><span style="color:#002339;">i) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 拿到SelectionKeyec</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">k</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeys</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">keys</span><span style="color:#002339;">[i];</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// null out entry in the array to allow to have it GC&#39;ed once the Channel close</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// See https://github.com/netty/netty/issues/2363</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">selectedKeys</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">keys</span><span style="color:#002339;">[i] </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 获取SelectionKey上的附件，即NioServerSocketChannel</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">a</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">k</span><span style="color:#002339;">.</span><span style="color:#7EB233;">attachment</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (a </span><span style="color:#7B30D0;">instanceof</span><span style="color:#002339;"> AbstractNioChannel) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 处理事件，传入附件NioServerSocketChannel</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">processSelectedKey</span><span style="color:#002339;">(k, (AbstractNioChannel) a);</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            @</span><span style="color:#0991B6;">SuppressWarnings</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;unchecked&quot;</span><span style="color:#002339;">)</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">NioTask</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">SelectableChannel</span><span style="color:#002339;">&gt; </span><span style="color:#2F86D2;">task</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">NioTask</span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;">SelectableChannel</span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;">) a;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">processSelectedKey</span><span style="color:#002339;">(k, task);</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (needsToSelectAgain) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// null out entries in the array to allow to have it GC&#39;ed once the Channel close</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// See https://github.com/netty/netty/issues/2363</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">selectedKeys</span><span style="color:#002339;">.</span><span style="color:#7EB233;">reset</span><span style="color:#002339;">(i </span><span style="color:#7B30D0;">+</span><span style="color:#002339;"> </span><span style="color:#174781;">1</span><span style="color:#002339;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">selectAgain</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            i </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">-</span><span style="color:#174781;">1</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>该方法中通过fori的方法，遍历基于数组的SelectedKey，通过</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">k</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectedKeys</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">keys</span><span style="color:#002339;">[i];</span></span></code></pre></div><p>获取到SelectionKey，<strong>然后获取其再Register时添加的附件NioServerSocketChannel</strong></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 获取SelectionKey上的附件，即NioServerSocketChannel</span></span>
<span class="line"><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">a</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">k</span><span style="color:#002339;">.</span><span style="color:#7EB233;">attachment</span><span style="color:#002339;">();</span></span></code></pre></div><p>如果附件继承自AbstractNioChannel，则会调用</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 处理事件，传入附件NioServerSocketChannel</span></span>
<span class="line"><span style="color:#7EB233;">processSelectedKey</span><span style="color:#002339;">(k, (AbstractNioChannel) a);</span></span></code></pre></div><p>去处理各个事件</p><p>真正处理各种事件的方法processSelectedKey</p><p>获取SelectionKey的事件，然后进行相应处理</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">processSelectedKey</span><span style="color:#002339;">(</span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> k, </span><span style="color:#0991B6;">AbstractNioChannel</span><span style="color:#002339;"> ch) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">AbstractNioChannel</span><span style="color:#002339;">.</span><span style="color:#0991B6;">NioUnsafe</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ch</span><span style="color:#002339;">.</span><span style="color:#7EB233;">unsafe</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#2F86D2;">k</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isValid</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">EventLoop</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            eventLoop </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ch</span><span style="color:#002339;">.</span><span style="color:#7EB233;">eventLoop</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">ignored</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// If the channel implementation throws an exception because there is no event loop, we ignore this</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// because we are only trying to determine if ch is registered to this event loop and thus has authority</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// to close ch.</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// still healthy and should not be closed.</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// See https://github.com/netty/netty/issues/5125</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (eventLoop </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#000000;">this</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// close the channel if the key is not valid anymore</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">voidPromise</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">readyOps</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">k</span><span style="color:#002339;">.</span><span style="color:#7EB233;">readyOps</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// the NIO JDK channel implementation may throw a NotYetConnectedException.</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((readyOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_CONNECT</span><span style="color:#002339;">) </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// See https://github.com/netty/netty/issues/924</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ops</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">k</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            ops </span><span style="color:#7B30D0;">&amp;=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">~</span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_CONNECT</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">k</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">(ops);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">finishConnect</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((readyOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_WRITE</span><span style="color:#002339;">) </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">ch</span><span style="color:#002339;">.</span><span style="color:#7EB233;">unsafe</span><span style="color:#002339;">().</span><span style="color:#7EB233;">forceFlush</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// to a spin loop</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((readyOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_READ</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">|</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_ACCEPT</span><span style="color:#002339;">)) </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">||</span><span style="color:#002339;"> readyOps </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">read</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">CancelledKeyException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">ignored</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">voidPromise</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h2 id="accept剖析" tabindex="-1">Accept剖析 <a class="header-anchor" href="#accept剖析" aria-label="Permalink to &quot;Accept剖析&quot;">​</a></h2><h3 id="nio中处理accept事件流程" tabindex="-1">NIO中处理Accept事件流程 <a class="header-anchor" href="#nio中处理accept事件流程" aria-label="Permalink to &quot;NIO中处理Accept事件流程&quot;">​</a></h3><ul><li>selector.select()阻塞线程，直到事件发生</li><li>遍历selectionKeys</li><li>获取一个key，判断事件类型是否为Accept</li></ul><hr><ul><li>创建SocketChannel，设置为非阻塞</li><li>将SocketChannel注册到selector中</li><li>关注selectionKeys的read事件</li></ul><p>代码如下</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 阻塞直到事件发生</span></span>
<span class="line"><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">select</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#0991B6;">Iterator</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;">&gt; </span><span style="color:#2F86D2;">iter</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selector</span><span style="color:#002339;">.</span><span style="color:#7EB233;">selectionKeys</span><span style="color:#002339;">().</span><span style="color:#7EB233;">iterator</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#7B30D0;">while</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">iter</span><span style="color:#002339;">.</span><span style="color:#7EB233;">hasNext</span><span style="color:#002339;">()) {    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 拿到一个事件</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">key</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">iter</span><span style="color:#002339;">.</span><span style="color:#7EB233;">next</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 如果是 accept 事件</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">key</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isAcceptable</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 执行accept，获得SocketChannel</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">SocketChannel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">serverSocketChannel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">accept</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">configureBlocking</span><span style="color:#002339;">(</span><span style="color:#174781;">false</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 将SocketChannel注册到selector中，并关注read事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(selector, </span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_READ</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// ...</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>其中前三步，在NioEventLoop剖析中已经分析过了，所以接下来主要分析后三步</p><h3 id="socketchannel的创建与注册" tabindex="-1">SocketChannel的创建与注册 <a class="header-anchor" href="#socketchannel的创建与注册" aria-label="Permalink to &quot;SocketChannel的创建与注册&quot;">​</a></h3><p>发生Accept事件后，会执行NioEventLoop.run方法的如下if分支</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((readyOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_READ</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">|</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_ACCEPT</span><span style="color:#002339;">)) </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">||</span><span style="color:#002339;"> readyOps </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">read</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>NioMessageUnsafe.read方法</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">read</span><span style="color:#002339;">() {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">do</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">				</span><span style="color:#357B42;font-style:italic;">// doReadMessages中执行了accept获得了SocketChannel</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 并创建NioSocketChannel作为消息放入readBuf</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// readBuf是一个ArrayList用来缓存消息</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// private final List&lt;Object&gt; readBuf = new ArrayList&lt;Object&gt;();</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">localRead</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doReadMessages</span><span style="color:#002339;">(readBuf);</span></span>
<span class="line"><span style="color:#002339;">                </span></span>
<span class="line"><span style="color:#002339;">                ...</span></span>
<span class="line"><span style="color:#002339;">                </span></span>
<span class="line"><span style="color:#002339;">				</span><span style="color:#357B42;font-style:italic;">// localRead值为1，就一条消息，即接收一个客户端连接</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">incMessagesRead</span><span style="color:#002339;">(localRead);</span></span>
<span class="line"><span style="color:#002339;">            } </span><span style="color:#7B30D0;">while</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">continueReading</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            exception </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> t;</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">size</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">readBuf</span><span style="color:#002339;">.</span><span style="color:#7EB233;">size</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">i</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">; i </span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;"> size; i </span><span style="color:#7B30D0;">++</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            readPending </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 触发read事件，让pipeline上的handler处理</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// ServerBootstrapAcceptor.channelRead</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelRead</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">readBuf</span><span style="color:#002339;">.</span><span style="color:#7EB233;">get</span><span style="color:#002339;">(i));</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">readPending </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">!</span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isAutoRead</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">removeReadOp</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>NioSocketChannel.doReadMessages方法<br>该方法中处理accpet事件，获得SocketChannel，同时创建了NioSocketChannel，作为消息放在了readBuf中</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doReadMessages</span><span style="color:#002339;">(</span><span style="color:#0991B6;">List</span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;">Object</span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> buf) throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 处理accpet事件，获得SocketChannel</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">SocketChannel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ch</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SocketUtils</span><span style="color:#002339;">.</span><span style="color:#7EB233;">accept</span><span style="color:#002339;">(</span><span style="color:#7EB233;">javaChannel</span><span style="color:#002339;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (ch </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 创建了NioSocketChannel，作为消息放在了readBuf中</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">buf</span><span style="color:#002339;">.</span><span style="color:#7EB233;">add</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">NioSocketChannel</span><span style="color:#002339;">(</span><span style="color:#000000;">this</span><span style="color:#002339;">, ch));</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#174781;">1</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">       ...</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>ServerBootstrapAcceptor.channelRead</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">channelRead</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelHandlerContext</span><span style="color:#002339;"> ctx, </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> msg) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 这时的msg是NioSocketChannel</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">child</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> (Channel) msg;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// NioSocketChannel添加childHandler，即初始化器</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">child</span><span style="color:#002339;">.</span><span style="color:#7EB233;">pipeline</span><span style="color:#002339;">().</span><span style="color:#7EB233;">addLast</span><span style="color:#002339;">(childHandler);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 设置选项</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">setChannelOptions</span><span style="color:#002339;">(child, childOptions, logger);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Entry</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">AttributeKey</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">?</span><span style="color:#002339;">&gt;, </span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt; </span><span style="color:#2F86D2;">e</span><span style="color:#7B30D0;">:</span><span style="color:#002339;"> childAttrs) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">child</span><span style="color:#002339;">.</span><span style="color:#7EB233;">attr</span><span style="color:#002339;">((</span><span style="color:#0991B6;">AttributeKey</span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;">Object</span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;">) </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getKey</span><span style="color:#002339;">()).</span><span style="color:#7EB233;">set</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getValue</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 注册 NioSocketChannel到nio worker线程，接下来的处理也移交至nio worker线程</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">childGroup</span><span style="color:#002339;">.</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(child).</span><span style="color:#7EB233;">addListener</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ChannelFutureListener</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">            @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">operationComplete</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelFuture</span><span style="color:#002339;"> </span><span style="color:#B1108E;">future</span><span style="color:#002339;">) </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Exception</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#2F86D2;">future</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isSuccess</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7EB233;">forceClose</span><span style="color:#002339;">(child, </span><span style="color:#2F86D2;">future</span><span style="color:#002339;">.</span><span style="color:#7EB233;">cause</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        });</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">forceClose</span><span style="color:#002339;">(child, t);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>通过AbstractUnsafe.register 方法，将SocketChannel注册到了Selector中，过程与启动流程中的Register过程类似</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">register</span><span style="color:#002339;">(</span><span style="color:#0991B6;">EventLoop</span><span style="color:#002339;"> eventLoop, </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelPromise</span><span style="color:#002339;"> promise) {</span></span>
<span class="line"><span style="color:#002339;">    </span></span>
<span class="line"><span style="color:#002339;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">AbstractChannel</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> eventLoop;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;">.</span><span style="color:#7EB233;">inEventLoop</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">register0</span><span style="color:#002339;">(promise);</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 这行代码完成的是nio boss -&gt; nio worker线程的切换</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">eventLoop</span><span style="color:#002339;">.</span><span style="color:#7EB233;">execute</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Runnable</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">                @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">run</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#357B42;font-style:italic;">// 真正的注册操作</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#7EB233;">register0</span><span style="color:#002339;">(promise);</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            });</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            ...</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>AbstractChannel.AbstractUnsafe.register0</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">register0</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelPromise</span><span style="color:#002339;"> promise) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        ...</span></span>
<span class="line"><span style="color:#002339;">            </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 该方法将SocketChannel注册到Selector中</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">doRegister</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 执行初始化器，执行前 pipeline 中只有 head -&gt; 初始化器 -&gt; tail</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">invokeHandlerAddedIfNeeded</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 执行后就是 head -&gt; logging handler -&gt; my handler -&gt; tail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">safeSetSuccess</span><span style="color:#002339;">(promise);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelRegistered</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7EB233;">isActive</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (firstRegistration) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#357B42;font-style:italic;">// 触发pipeline上active事件</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelActive</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            } </span><span style="color:#7B30D0;">else</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7EB233;">config</span><span style="color:#002339;">().</span><span style="color:#7EB233;">isAutoRead</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7EB233;">beginRead</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">closeForcibly</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">closeFuture</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setClosed</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">safeSetFailure</span><span style="color:#002339;">(promise, t);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>AbstractNioChannel.doRegister将SocketChannel注册到Selector中</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doRegister</span><span style="color:#002339;">() throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selected</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">for</span><span style="color:#002339;"> (;;) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 将Selector注册到Selector中</span></span>
<span class="line"><span style="color:#002339;">            selectionKey </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">javaChannel</span><span style="color:#002339;">().</span><span style="color:#7EB233;">register</span><span style="color:#002339;">(</span><span style="color:#7EB233;">eventLoop</span><span style="color:#002339;">().</span><span style="color:#7EB233;">unwrappedSelector</span><span style="color:#002339;">(), </span><span style="color:#174781;">0</span><span style="color:#002339;">, </span><span style="color:#000000;">this</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">CancelledKeyException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            ...</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>HeadContext.channelActive</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">channelActive</span><span style="color:#002339;">(</span><span style="color:#0991B6;">ChannelHandlerContext</span><span style="color:#002339;"> ctx) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">ctx</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelActive</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#357B42;font-style:italic;">// 触发read(NioSocketChannel这里read只是为了触发channel的事件注册，还未涉及数据读取)</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7EB233;">readIfIsAutoRead</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>AbstractNioChannel.doBeginRead，通过该方法，SocketChannel关注了read事件</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">protected</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">doBeginRead</span><span style="color:#002339;">() throws Exception {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// Channel.read() or ChannelHandlerContext.read() was called</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">SelectionKey</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#000000;">this</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isValid</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    readPending </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">true</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#357B42;font-style:italic;">// 这时候 interestOps是0</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">int</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">interestOps</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((interestOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> readInterestOp) </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 关注read事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">selectionKey</span><span style="color:#002339;">.</span><span style="color:#7EB233;">interestOps</span><span style="color:#002339;">(interestOps </span><span style="color:#7B30D0;">|</span><span style="color:#002339;"> readInterestOp);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h2 id="read剖析" tabindex="-1">Read剖析 <a class="header-anchor" href="#read剖析" aria-label="Permalink to &quot;Read剖析&quot;">​</a></h2><p>read事件的处理也是在</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">if</span><span style="color:#002339;"> ((readyOps </span><span style="color:#7B30D0;">&amp;</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_READ</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">|</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">SelectionKey</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">OP_ACCEPT</span><span style="color:#002339;">)) </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">||</span><span style="color:#002339;"> readyOps </span><span style="color:#7B30D0;">==</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#2F86D2;">unsafe</span><span style="color:#002339;">.</span><span style="color:#7EB233;">read</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>分支中，通过unsafe.read()方法处理的，不过此处调用的方法在AbstractNioByteChannel.NioByteUnsafe类中</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">read</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 获得Channel的配置</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelConfig</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">config</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">config</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7EB233;">shouldBreakReadReady</span><span style="color:#002339;">(config)) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">clearReadPending</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ChannelPipeline</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">pipeline</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#357B42;font-style:italic;">// 根据配置创建ByteBufAllocator（池化非池化、直接非直接内存）</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">ByteBufAllocator</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">allocator</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getAllocator</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 用来分配 byteBuf，确定单次读取大小</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">final</span><span style="color:#002339;"> </span><span style="color:#0991B6;">RecvByteBufAllocator</span><span style="color:#002339;">.</span><span style="color:#0991B6;">Handle</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7EB233;">recvBufAllocHandle</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">reset</span><span style="color:#002339;">(config);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">ByteBuf</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">byteBuf</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">close</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">do</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 创建ByteBuf</span></span>
<span class="line"><span style="color:#002339;">            byteBuf </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">allocate</span><span style="color:#002339;">(allocator);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 读取内容，放入ByteBUf中</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">lastBytesRead</span><span style="color:#002339;">(</span><span style="color:#7EB233;">doReadBytes</span><span style="color:#002339;">(byteBuf));</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">lastBytesRead</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">&lt;=</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#2F86D2;">byteBuf</span><span style="color:#002339;">.</span><span style="color:#7EB233;">release</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                byteBuf </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">                close </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">lastBytesRead</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (close) {</span></span>
<span class="line"><span style="color:#002339;">                    readPending </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">break</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">incMessagesRead</span><span style="color:#002339;">(</span><span style="color:#174781;">1</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            readPending </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">false</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 触发read 事件，让pipeline上的handler处理</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 这时是处理NioSocketChannel上的handler</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelRead</span><span style="color:#002339;">(byteBuf);</span></span>
<span class="line"><span style="color:#002339;">            byteBuf </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        } </span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 是否要继续循环</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">while</span><span style="color:#002339;"> (</span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">continueReading</span><span style="color:#002339;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">allocHandle</span><span style="color:#002339;">.</span><span style="color:#7EB233;">readComplete</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 触发 read complete事件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">pipeline</span><span style="color:#002339;">.</span><span style="color:#7EB233;">fireChannelReadComplete</span><span style="color:#002339;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (close) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">closeOnRead</span><span style="color:#002339;">(pipeline);</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Throwable</span><span style="color:#002339;"> </span><span style="color:#B1108E;">t</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7EB233;">handleReadException</span><span style="color:#002339;">(pipeline, byteBuf, t, close, allocHandle);</span></span>
<span class="line"><span style="color:#002339;">    } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">         </span><span style="color:#357B42;font-style:italic;">// Check if there is a readPending which was not processed yet.</span></span>
<span class="line"><span style="color:#002339;">         </span><span style="color:#357B42;font-style:italic;">// This could be for two reasons:</span></span>
<span class="line"><span style="color:#002339;">         </span><span style="color:#357B42;font-style:italic;">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></span>
<span class="line"><span style="color:#002339;">         </span><span style="color:#357B42;font-style:italic;">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></span>
<span class="line"><span style="color:#002339;">         </span><span style="color:#357B42;font-style:italic;">//</span></span>
<span class="line"><span style="color:#002339;">         </span><span style="color:#357B42;font-style:italic;">// See https://github.com/netty/netty/issues/2254</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">readPending </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">!</span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isAutoRead</span><span style="color:#002339;">()) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7EB233;">removeReadOp</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle.continueReading(io.netty.util.UncheckedBooleanSupplier)</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">boolean</span><span style="color:#002339;"> </span><span style="color:#7EB233;">continueReading</span><span style="color:#002339;">(</span><span style="color:#0991B6;">UncheckedBooleanSupplier</span><span style="color:#002339;"> maybeMoreDataSupplier) {</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span></span>
<span class="line"><span style="color:#002339;">           </span><span style="color:#357B42;font-style:italic;">// 一般为true</span></span>
<span class="line"><span style="color:#002339;">           </span><span style="color:#2F86D2;">config</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isAutoRead</span><span style="color:#002339;">() </span><span style="color:#7B30D0;">&amp;&amp;</span></span>
<span class="line"><span style="color:#002339;">           </span><span style="color:#357B42;font-style:italic;">// respectMaybeMoreData默认为true</span></span>
<span class="line"><span style="color:#002339;">           </span><span style="color:#357B42;font-style:italic;">// maybeMoreDataSupplier的逻辑是如果预期读取字节与实际读取字节相等，返回true</span></span>
<span class="line"><span style="color:#002339;">           (</span><span style="color:#7B30D0;">!</span><span style="color:#002339;">respectMaybeMoreData </span><span style="color:#7B30D0;">||</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">maybeMoreDataSupplier</span><span style="color:#002339;">.</span><span style="color:#7EB233;">get</span><span style="color:#002339;">()) </span><span style="color:#7B30D0;">&amp;&amp;</span></span>
<span class="line"><span style="color:#002339;">           </span><span style="color:#357B42;font-style:italic;">// 小于最大次数，maxMessagePerRead默认16</span></span>
<span class="line"><span style="color:#002339;">           totalMessages </span><span style="color:#7B30D0;">&lt;</span><span style="color:#002339;"> maxMessagePerRead </span><span style="color:#7B30D0;">&amp;&amp;</span></span>
<span class="line"><span style="color:#002339;">           </span><span style="color:#357B42;font-style:italic;">// 实际读到了数据</span></span>
<span class="line"><span style="color:#002339;">           totalBytesRead </span><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> </span><span style="color:#174781;">0</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><div class="edit-info" data-v-ef5dee53><div class="edit-link" data-v-ef5dee53><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/fxbsujay/Sujay-Docs/blob/main/docs/blog/netty.md" target="_blank" rel="noreferrer" data-v-ef5dee53><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-ef5dee53><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 在 GitHub 上编辑此页面<!--]--></a></div><div class="last-updated" data-v-ef5dee53><p class="VPLastUpdated" data-v-ef5dee53 data-v-7de715c0>最近更新时间: <time datetime="2023-05-10T15:24:13.000Z" data-v-7de715c0></time></p></div></div><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/blog/elk.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>上一页</span><span class="title" data-v-ef5dee53>ELK 学习文档</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/blog/snow-flake.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>下一页</span><span class="title" data-v-ef5dee53>雪花算法</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-1919c326 data-v-e03eb2e1><div class="container" data-v-e03eb2e1><p class="message" data-v-e03eb2e1>Released under the <a href="https://github.com/fxbsujay/Sujay-Docs/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-e03eb2e1>Copyright © 2020-present <a href="https://github.com/fxbsujay">Fan XueBin</a> <a href="https://beian.miit.gov.cn/">鲁ICP备2022006050号-1</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blog_hexo.md\":\"a84aa174\",\"blog_css.md\":\"e4763fc2\",\"blog_eventloop.md\":\"471536b1\",\"blog_bit_operation.md\":\"db10f3b8\",\"blog_jdk_support.md\":\"f9931fb7\",\"components_button.md\":\"439755e4\",\"blog_shiwu.md\":\"bd992913\",\"blog_docker.md\":\"cb9c53a8\",\"blog_mysql_index.md\":\"d7e8a110\",\"components_overview.md\":\"4c21adf3\",\"blog_mymap.md\":\"b912d4ee\",\"blog_seata-sharding.md\":\"1375f7d8\",\"index.md\":\"25f20114\",\"blog_text.md\":\"d495ba65\",\"blog_snow-flake.md\":\"8bc954db\",\"blog_vue.md\":\"383b36ee\",\"blog_juc.md\":\"953e4d26\",\"blog_mysql.md\":\"f6ac6a27\",\"blog_redis.md\":\"ac42df03\",\"blog_mq.md\":\"5f8384e8\",\"blog_netty.md\":\"90136efb\",\"blog_elk.md\":\"59399ef9\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Sujay\",\"titleTemplate\":\":title - Sujay\",\"description\":\"Sujay Blog.\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/favicon.ico\",\"siteTitle\":\"Fan Xuebin\",\"outline\":{\"level\":\"deep\",\"label\":\"大纲\"},\"lastUpdated\":{\"text\":\"最近更新时间\"},\"editLink\":{\"pattern\":\"https://github.com/fxbsujay/Sujay-Docs/blob/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页面\"},\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"returnToTopLabel\":\"返回\",\"sidebarMenuLabel\":\"目录\",\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/fxbsujay/Sujay-Docs/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright © 2020-present <a href=\\\"https://github.com/fxbsujay\\\">Fan XueBin</a> <a href=\\\"https://beian.miit.gov.cn/\\\">鲁ICP备2022006050号-1</a>\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/fxbsujay\"}],\"nav\":[{\"text\":\"博客\",\"link\":\"/blog/jdk_support\",\"activeMatch\":\"/blog/\"},{\"text\":\"UI组件库\",\"link\":\"/components/button\",\"activeMatch\":\"/components/\"}],\"sidebar\":{\"/blog\":[{\"text\":\"后端知识库\",\"collapsed\":false,\"items\":[{\"text\":\"JAVA JDK17 新特性\",\"link\":\"/blog/jdk_support\"},{\"text\":\"位运算\",\"link\":\"/blog/bit_operation\"},{\"text\":\"Redis\",\"link\":\"/blog/redis\"},{\"text\":\"Docker\",\"link\":\"/blog/docker\"},{\"text\":\"MySql\",\"link\":\"/blog/mysql\"},{\"text\":\"MySql 索引\",\"link\":\"/blog/mysql_index\"},{\"text\":\"Java JUC\",\"link\":\"/blog/juc\"},{\"text\":\"消息队列\",\"link\":\"/blog/mq\"},{\"text\":\"ELK 学习文档\",\"link\":\"/blog/elk\"},{\"text\":\"Netty 源码分析\",\"link\":\"/blog/netty\"},{\"text\":\"雪花算法\",\"link\":\"/blog/snow-flake\"},{\"text\":\"实现一个简易Map\",\"link\":\"/blog/mymap\"},{\"text\":\"Seata 分布式事务\",\"link\":\"/blog/shiwu\"}]},{\"text\":\"前端知识库\",\"collapsed\":false,\"items\":[{\"text\":\"css选择器\",\"link\":\"/blog/css\"},{\"text\":\"事件循环\",\"link\":\"/blog/eventLoop\"},{\"text\":\"Vue3 快速上手\",\"link\":\"/blog/vue\"}]},{\"text\":\"生活小工具\",\"collapsed\":false,\"items\":[{\"text\":\"使用 Hexo 搭建一个博客\",\"link\":\"/blog/hexo\"},{\"text\":\"示例\",\"link\":\"/blog/text\"}]}],\"/components\":[{\"text\":\"基础组件\",\"collapsed\":false,\"items\":[{\"text\":\"按钮\",\"link\":\"/components/button\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>