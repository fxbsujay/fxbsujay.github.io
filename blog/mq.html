<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息队列 - Sujay</title>
    <meta name="description" content="Sujay Blog.">
    <link rel="preload stylesheet" href="/assets/style.24f015e4.css" as="style">
    
    <script type="module" src="/assets/app.fa9b4eef.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.4cf23e62.js">
    <link rel="modulepreload" href="/assets/chunks/theme.0be83c97.js">
    <link rel="modulepreload" href="/assets/blog_mq.md.5f8384e8.lean.js">
    <link rel="icon" href="/favicon.ico">
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1919c326><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-1919c326 data-v-7e5bc4a5><div class="VPNavBar has-sidebar" data-v-7e5bc4a5 data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!--[--><img class="VPImage logo" src="/favicon.ico" alt data-v-8426fc1a><!--]--><!--[-->Fan Xuebin<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/blog/jdk_support.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>博客</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/components/button.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>UI组件库</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-f6a63727><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-f6a63727 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/fxbsujay" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/fxbsujay" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-1919c326 data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>目录</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>返回</button><!----></div></div><aside class="VPSidebar" data-v-1919c326 data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>后端知识库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/jdk_support.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>JAVA JDK17 新特性</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/bit_operation.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>位运算</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/redis.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Redis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/docker.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Docker</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mysql.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MySql</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mysql_index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>MySql 索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/juc.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Java JUC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mq.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>消息队列</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/elk.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>ELK 学习文档</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/netty.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Netty 源码分析</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/snow-flake.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>雪花算法</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/mymap.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>实现一个简易Map</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/shiwu.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Seata 分布式事务</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>前端知识库</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/css.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>css选择器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/eventLoop.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>事件循环</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/vue.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Vue3 快速上手</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 collapsible" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>生活小工具</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-e31bd47b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-e31bd47b><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/hexo.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>使用 Hexo 搭建一个博客</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/blog/text.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>示例</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1919c326 data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>大纲</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _blog_mq" data-v-6b87e69f><div><h1 id="消息队列" tabindex="-1">消息队列 <a class="header-anchor" href="#消息队列" aria-label="Permalink to &quot;消息队列&quot;">​</a></h1><h2 id="协议概括" tabindex="-1">协议概括 <a class="header-anchor" href="#协议概括" aria-label="Permalink to &quot;协议概括&quot;">​</a></h2><h3 id="应用场景" tabindex="-1">应用场景 <a class="header-anchor" href="#应用场景" aria-label="Permalink to &quot;应用场景&quot;">​</a></h3><ol><li>跨系统数据传递</li><li>高并发的流量削峰</li><li>数据的分发和异步处理</li><li>大数据的分析与传递</li><li>分布式事务</li></ol><h3 id="网络协议" tabindex="-1">网络协议 <a class="header-anchor" href="#网络协议" aria-label="Permalink to &quot;网络协议&quot;">​</a></h3><ol><li>语法 语法是用户数据与控制信息的结构与格式，以及数据出现的顺序</li><li>语义 解释控制信息每个部分的意义，它规定了需要发出何种控制信息以及完成的动作与做出什么样的响应</li><li>时序 时序是对事件发生顺序的详细说明</li></ol><div class="tip custom-block line"> 消息中间件不采用http协议，而常见的消息中间件协议有：OpenWire、AWQP、MQTT、Kafka、OpenMessage </div><details class="details custom-block"><summary>为什么不使用http协议？（面试题）</summary><ol><li>因为http请求报文头和响应报文头是比较复杂，包含了cookie，数据的加密解密，状态码，响应码等附加的功能但是对于一个消息而言，并不需要这么复杂，也没必要，它其实就是负责数据传递，存储分发就行，保证高性能</li><li>大部分情况下http大部分都是短连接，在实际的交互过程中，一个请求到响应很有可能会中断，中断以后就不会持久化，就会造成请求的丢失，这样就不利于消息中间件的业务场景，因为消息中间件可能是一个长期的 获取消息的过程，出现问题和故障要对数据或消息就行持久化等，目的就是为了保证消息和数据的高可靠和稳建的运行</li></ol></details><h3 id="amqp" tabindex="-1">AMQP <a class="header-anchor" href="#amqp" aria-label="Permalink to &quot;AMQP&quot;">​</a></h3><p>Advanced Message Queueing Protocol 高级消息队列协议，由摩根大通集团联合设计，Erlang语言开发</p><ol><li>分布式事务支持</li><li>消息的持久化支持</li><li>高性能和高可靠的消息出来优势</li><li>支持者：RabbitMQ、ActiveMQ</li></ol><h3 id="mqtt" tabindex="-1">MQTT <a class="header-anchor" href="#mqtt" aria-label="Permalink to &quot;MQTT&quot;">​</a></h3><p>Message Queueing Telemetry Transport IBM开发的即时通讯协议，物联网系统架构的组成部分</p><ol><li>轻量</li><li>结构简单</li><li>传输快，不支持事务</li><li>没有持久化</li><li>适用于计算能力有限，地带宽，网络不稳定的场景</li><li>支持者：RabbitMQ、ActiveMQ</li></ol><h3 id="openmessage" tabindex="-1">OpenMessage <a class="header-anchor" href="#openmessage" aria-label="Permalink to &quot;OpenMessage&quot;">​</a></h3><p>由阿里、雅虎、滴滴、Stremalio等公司共同参与创建的分布式消息中间件、流处理等领域的应用开发标准</p><ol><li>结构简单</li><li>解析速度快</li><li>支持事务和持久化设计</li></ol><h3 id="kafka" tabindex="-1">Kafka <a class="header-anchor" href="#kafka" aria-label="Permalink to &quot;Kafka&quot;">​</a></h3><p>基于TCP/IP的二进制协议，消息内部是通过长度来分割，由一些基本数据类型加成</p><ol><li>结构简单</li><li>解析速度快</li><li>无事务支持</li><li>有持久化设计</li></ol><h2 id="消息持久化" tabindex="-1">消息持久化 <a class="header-anchor" href="#消息持久化" aria-label="Permalink to &quot;消息持久化&quot;">​</a></h2><p>简单来说就是将数据存入磁盘，而不是存在内存中随服务器重启断开而消失，使数据能够永久保存</p><table><thead><tr><th></th><th><strong>ActiveMQ</strong></th><th><strong>RabbitMQ</strong></th><th><strong>Kafka</strong></th><th><strong>RocketMQ</strong></th></tr></thead><tbody><tr><td>文件存储</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>数据库</td><td>支持</td><td>/</td><td>/</td><td>/</td></tr></tbody></table><h2 id="消息分发" tabindex="-1">消息分发 <a class="header-anchor" href="#消息分发" aria-label="Permalink to &quot;消息分发&quot;">​</a></h2><h3 id="分发策略" tabindex="-1">分发策略 <a class="header-anchor" href="#分发策略" aria-label="Permalink to &quot;分发策略&quot;">​</a></h3><p>MQ消息队列有如下几种角色</p><ol><li>生产者</li><li>消费者</li><li>存储消息</li></ol><p>那么生产者生产消息后，MQ进行存储，消费者如何获取消息的呢？一般获取数据的方式无外乎推（push）或者拉取（pull）两种方式，典型的git就有推拉机制</p><p>我们发送的http请求就是一种典型的拉取数据库数据返回的过程，而消息队列MQ是一种推送的过程，而这些机制会适用到很多的业务场景也有很多对应推机制策略</p><h3 id="场景分析-一" tabindex="-1">场景分析 一 <a class="header-anchor" href="#场景分析-一" aria-label="Permalink to &quot;场景分析 一&quot;">​</a></h3><p><img src="/doc/mq/img-0.png" alt="image.png"></p><h3 id="场景分析-二" tabindex="-1">场景分析 二 <a class="header-anchor" href="#场景分析-二" aria-label="Permalink to &quot;场景分析 二&quot;">​</a></h3><p><img src="/doc/mq/img-1.png" alt="image.png"></p><h3 id="消息分发策略的机制与对比" tabindex="-1">消息分发策略的机制与对比 <a class="header-anchor" href="#消息分发策略的机制与对比" aria-label="Permalink to &quot;消息分发策略的机制与对比&quot;">​</a></h3><table><thead><tr><th></th><th><strong>AvtiveMQ</strong></th><th><strong>RabbitMQ</strong></th><th><strong>Kafka</strong></th><th><strong>RocketMQ</strong></th></tr></thead><tbody><tr><td>发布订阅</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>轮询分发</td><td>支持</td><td>支持</td><td>支持</td><td>/</td></tr><tr><td>公平分发</td><td>/</td><td>支持</td><td>支持</td><td>/</td></tr><tr><td>重发</td><td>支持</td><td>支持</td><td>/</td><td>支持</td></tr><tr><td>消息拉取</td><td>/</td><td>支持</td><td>支持</td><td>支持</td></tr></tbody></table><h2 id="高可用、高可靠" tabindex="-1">高可用、高可靠 <a class="header-anchor" href="#高可用、高可靠" aria-label="Permalink to &quot;高可用、高可靠&quot;">​</a></h2><h3 id="集群模式-1-master-slave主从共享数据的部署方式" tabindex="-1">集群模式 1 - Master-slave主从共享数据的部署方式 <a class="header-anchor" href="#集群模式-1-master-slave主从共享数据的部署方式" aria-label="Permalink to &quot;集群模式 1 - Master-slave主从共享数据的部署方式&quot;">​</a></h3><p><img src="/doc/mq/img-2.png" alt="image.png"></p><p>生产者将消费者发送到Master节点，所有的都连接这个消息队列共享这块数据区域，Master节点负债写入，一旦 Master挂掉，slave节点继续服务，从而形成高可用</p><h3 id="集群模式-2-master-slave主从同步的部署方式" tabindex="-1">集群模式 2 - Master-slave主从同步的部署方式 <a class="header-anchor" href="#集群模式-2-master-slave主从同步的部署方式" aria-label="Permalink to &quot;集群模式 2 - Master-slave主从同步的部署方式&quot;">​</a></h3><p><img src="/doc/mq/img-3.png" alt="image.png"></p><p>这种模式写入消息同样在Master主节点上，但是主节点会同步数据到slave节点形成副本，和zookeeper或者redis主从机制很类同，这样可以达到负载均衡的效果，如果消费者有多个这样就可以去不同的节点就行消费，以为消息的拷贝和同步会暂用很大的带宽和网络资源，在后续的rabbtmq中会有使用</p><h3 id="集群模式-3-多主集群同步部署方式" tabindex="-1">集群模式 3 - 多主集群同步部署方式 <a class="header-anchor" href="#集群模式-3-多主集群同步部署方式" aria-label="Permalink to &quot;集群模式 3 - 多主集群同步部署方式&quot;">​</a></h3><p><img src="/doc/mq/img-4.png" alt="image.png"></p><p>和上面的区别不是很大，但是它的写入可以往任意节点写入</p><h3 id="集群模式-4-多主集群转发部署方式" tabindex="-1">集群模式 4 - 多主集群转发部署方式 <a class="header-anchor" href="#集群模式-4-多主集群转发部署方式" aria-label="Permalink to &quot;集群模式 4 - 多主集群转发部署方式&quot;">​</a></h3><p><img src="/doc/mq/img-5.png" alt="image.png"></p><p>如果你插入的数据是broker-1中，元数据信息会存储数据的相关描述和记录存放的位置（队列） 它会对描述信息也就是元数据信息就行同步，如果消费者在broker-2中进行消费，发现自己几点没有对应的消息，可以从对应的元数据信息中查询，然后返回对应的消息信息，场景：比如买火车票或者黄牛买演唱会门票，比如一个黄牛有顾客说要买的演唱会门票，但是没有但是他会去联系其他的黄牛询问，如果有则返回</p><h3 id="集群模式-5-master-slave与breoker-cluster组合" tabindex="-1">集群模式 5 - Master-slave与Breoker-cluster组合 <a class="header-anchor" href="#集群模式-5-master-slave与breoker-cluster组合" aria-label="Permalink to &quot;集群模式 5 - Master-slave与Breoker-cluster组合&quot;">​</a></h3><p><img src="/doc/mq/img-6.png" alt="image.png"></p><p>实现多主多从的热备机制来完成消息的高可用以及数据的热备机制，在生产规模达到一定阶段的时候，这种使用的频率比较高</p><ol><li>要么消息共享</li><li>要么消息同步</li><li>要么元数据共享</li></ol><h3 id="什么是高可靠" tabindex="-1">什么是高可靠？ <a class="header-anchor" href="#什么是高可靠" aria-label="Permalink to &quot;什么是高可靠？&quot;">​</a></h3><p>所谓高可用是指系统可以无障碍低持续运行，比如一个系统突然崩溃，报错，异常等等并不影响线上业务的正常运行，出错的几率极低，就称为高可靠 在高并发的场景下，如果不能保证系统的高可靠，那造车的隐患和损失是非常严重的 如何保证中间值消息的可靠性？可以从两方面考虑：</p><ol><li>消息的传输：通过协议来保证系统间数据解析的正确性</li><li>消息的存储可靠：通过持久化来保证消息的可靠性</li></ol><h2 id="rabbitmq" tabindex="-1">RabbitMQ <a class="header-anchor" href="#rabbitmq" aria-label="Permalink to &quot;RabbitMQ&quot;">​</a></h2><p><a href="https://www.rabbitmq.com/" target="_blank" rel="noreferrer">官网</a> <a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noreferrer">下载地址</a></p><h3 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h3><p>环境：CentOS7.x + Erlang</p><h4 id="erlang安装" tabindex="-1"><a href="https://www.erlang.-solutions.com/downloads" target="_blank" rel="noreferrer">Erlang安装 </a> <a class="header-anchor" href="#erlang安装" aria-label="Permalink to &quot;[Erlang安装 ](https://www.erlang.-solutions.com/downloads)&quot;">​</a></h4><p>查看系统版本号</p><p><img src="/doc/mq/img-11.png" alt="image.png"></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 下载解压</span></span>
<span class="line"><span style="color:#002339;">wget https</span><span style="color:#7B30D0;">:</span><span style="color:#357B42;font-style:italic;">//packages.erlang-solutions.com/erlang-solutions-2.0-1.noarch.rpm</span></span>
<span class="line"><span style="color:#002339;">rpm </span><span style="color:#7B30D0;">-</span><span style="color:#0991B6;">Uvh</span><span style="color:#002339;"> erlang</span><span style="color:#7B30D0;">-</span><span style="color:#002339;">solutions</span><span style="color:#7B30D0;">-</span><span style="color:#174781;">2.0</span><span style="color:#7B30D0;">-</span><span style="color:#002339;">1.</span><span style="color:#2F86D2;">noarch</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 安装成功</span></span>
<span class="line"><span style="color:#002339;">yum install </span><span style="color:#7B30D0;">-</span><span style="color:#002339;">y erlang</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">erl </span><span style="color:#7B30D0;">-</span><span style="color:#002339;">v</span></span></code></pre></div><p>版本对照</p><p><img src="/doc/mq/img-7.png" alt="image.png"></p><h4 id="socat安装" tabindex="-1">socat安装 <a class="header-anchor" href="#socat安装" aria-label="Permalink to &quot;socat安装&quot;">​</a></h4><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">yum</span><span style="color:#002339;"> </span><span style="color:#A44185;">install</span><span style="color:#002339;"> </span><span style="color:#174781;">-y</span><span style="color:#002339;"> </span><span style="color:#A44185;">socat</span></span></code></pre></div><h4 id="解压mq" tabindex="-1">解压mq <a class="header-anchor" href="#解压mq" aria-label="Permalink to &quot;解压mq&quot;">​</a></h4><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">rpm</span><span style="color:#002339;"> </span><span style="color:#174781;">-Uvh</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server-3.8.13-1.el8.noarch.rpm</span></span>
<span class="line"><span style="color:#7EB233;">yum</span><span style="color:#002339;"> </span><span style="color:#A44185;">install</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq</span><span style="color:#002339;"> </span><span style="color:#174781;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7EB233;">//</span><span style="color:#002339;"> </span><span style="color:#A44185;">启动</span></span>
<span class="line"><span style="color:#7EB233;">systemctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">start</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server</span></span>
<span class="line"><span style="color:#7EB233;">//</span><span style="color:#002339;"> </span><span style="color:#A44185;">查询状态</span></span>
<span class="line"><span style="color:#7EB233;">systemctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">status</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server</span></span>
<span class="line"><span style="color:#7EB233;">//</span><span style="color:#002339;"> </span><span style="color:#A44185;">设置开机自启动</span></span>
<span class="line"><span style="color:#7EB233;">systemctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">enable</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server</span></span>
<span class="line"><span style="color:#7EB233;">//</span><span style="color:#002339;"> </span><span style="color:#A44185;">停止服务</span></span>
<span class="line"><span style="color:#7EB233;">systemctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">stop</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7EB233;">//</span><span style="color:#002339;"> </span><span style="color:#A44185;">windows</span><span style="color:#002339;"> </span><span style="color:#A44185;">插件</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmq-plugins</span><span style="color:#002339;"> </span><span style="color:#A44185;">enable</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq_management</span></span>
<span class="line"><span style="color:#7EB233;">http://localhost:15672/</span></span>
<span class="line"><span style="color:#7EB233;">//</span><span style="color:#002339;"> </span><span style="color:#A44185;">账号密码</span><span style="color:#002339;"> </span></span>
<span class="line"><span style="color:#7EB233;">guest</span></span></code></pre></div><h1 id="" tabindex="-1"><img src="/doc/mq/img-8.png" alt="image.png"> <a class="header-anchor" href="#" aria-label="Permalink to &quot;![image.png](/doc/mq/img-8.png)&quot;">​</a></h1><h4 id="docker安装" tabindex="-1">docker安装 <a class="header-anchor" href="#docker安装" aria-label="Permalink to &quot;docker安装&quot;">​</a></h4><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">docker</span><span style="color:#002339;"> </span><span style="color:#A44185;">pull</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq:management</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 简单创建 -hostname 容器主机名称 -name 容器名称 -p 映射本地</span></span>
<span class="line"><span style="color:#7EB233;">docker</span><span style="color:#002339;"> </span><span style="color:#A44185;">run</span><span style="color:#002339;"> </span><span style="color:#174781;">-di</span><span style="color:#002339;"> </span><span style="color:#174781;">--name=myrabbit</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#174781;">15672</span><span style="color:#A44185;">:15672</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq:management</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 创建并设置用户</span></span>
<span class="line"><span style="color:#7EB233;">docker</span><span style="color:#002339;"> </span><span style="color:#A44185;">run</span><span style="color:#002339;"> </span><span style="color:#174781;">-di</span><span style="color:#002339;"> </span><span style="color:#174781;">--name</span><span style="color:#002339;"> </span><span style="color:#A44185;">myrabbit</span><span style="color:#002339;"> </span><span style="color:#174781;">-e</span><span style="color:#002339;"> </span><span style="color:#A44185;">RABBITMQ_DEFAULT_USER=admin</span><span style="color:#002339;"> </span><span style="color:#174781;">-e</span><span style="color:#002339;"> </span><span style="color:#A44185;">RABBITMQ_DEFAULT_PASS=admin</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#174781;">15672</span><span style="color:#A44185;">:15672</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#174781;">5672</span><span style="color:#A44185;">:5672</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#174781;">25672</span><span style="color:#A44185;">:25672</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#174781;">61613</span><span style="color:#A44185;">:61613</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#174781;">1883</span><span style="color:#A44185;">:1883</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq:management</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 启动 </span></span>
<span class="line"><span style="color:#7EB233;">docker</span><span style="color:#002339;"> </span><span style="color:#A44185;">start</span><span style="color:#002339;"> </span><span style="color:#A44185;">id</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 地址 http://42.193.102.182:15672</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 开机自启动</span></span>
<span class="line"><span style="color:#7EB233;">docker</span><span style="color:#002339;"> </span><span style="color:#A44185;">update</span><span style="color:#002339;"> </span><span style="color:#A44185;">myrabbit</span><span style="color:#002339;"> </span><span style="color:#174781;">--restart=always</span></span></code></pre></div><h3 id="管理界面以及授权" tabindex="-1">管理界面以及授权 <a class="header-anchor" href="#管理界面以及授权" aria-label="Permalink to &quot;管理界面以及授权&quot;">​</a></h3><h4 id="安装-1" tabindex="-1">安装 <a class="header-anchor" href="#安装-1" aria-label="Permalink to &quot;安装&quot;">​</a></h4><p>默认情况下，rabbitMQ是没有安装web前端插件，需要安装才能生效</p><p>访问地址：<a href="http://localhost:15672/" target="_blank" rel="noreferrer">http://localhost:15672/</a></p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">rabbitmq-plugins</span><span style="color:#002339;"> </span><span style="color:#A44185;">enable</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq_management</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 重启服务</span></span>
<span class="line"><span style="color:#7EB233;">systemctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">restart</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 默认账号密码</span></span>
<span class="line"><span style="color:#7EB233;">guest</span><span style="color:#002339;"> </span><span style="color:#A44185;">只限本机访问</span></span></code></pre></div><p><img src="/doc/mq/img-9.png" alt="image.png"></p><h4 id="授权" tabindex="-1">授权 <a class="header-anchor" href="#授权" aria-label="Permalink to &quot;授权&quot;">​</a></h4><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;"># 新增用户</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">add_user</span><span style="color:#002339;"> </span><span style="color:#A44185;">admin</span><span style="color:#002339;"> </span><span style="color:#A44185;">admin</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 设置权限 超级管理员</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_user_tags</span><span style="color:#002339;"> </span><span style="color:#A44185;">admin</span><span style="color:#002339;"> </span><span style="color:#A44185;">administrator</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 授权资源权限</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_permissions</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#A44185;">/</span><span style="color:#002339;"> </span><span style="color:#A44185;">admin</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;.*&quot;</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;.*&quot;</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;.*&quot;</span></span></code></pre></div><p>用户级别：</p><ol><li>administrator 可以登录，查看所有信息，对rabbitmq进行管理</li><li>monitoring 监控者 登录，查看所有信息</li><li>pollicymaker 策略制定者 登录控制台，指定策略</li><li>managment 普通管理员 登录控制台</li></ol><p><img src="/doc/mq/img-10.png" alt="image.png"></p><h4 id="其他命令" tabindex="-1">其他命令 <a class="header-anchor" href="#其他命令" aria-label="Permalink to &quot;其他命令&quot;">​</a></h4><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">add_user</span><span style="color:#002339;"> </span><span style="color:#A44185;">账号</span><span style="color:#002339;"> </span><span style="color:#A44185;">密码</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_user_tags</span><span style="color:#002339;"> </span><span style="color:#A44185;">账号</span><span style="color:#002339;"> </span><span style="color:#A44185;">administrator</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">change_password</span><span style="color:#002339;"> </span><span style="color:#A44185;">username</span><span style="color:#002339;"> </span><span style="color:#A44185;">Newpassword</span><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;"># 修改密码</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">delete_user</span><span style="color:#002339;"> </span><span style="color:#A44185;">Username</span><span style="color:#002339;"> </span><span style="color:#357B42;font-style:italic;"># 删除用户</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">list_users</span><span style="color:#002339;"> </span><span style="color:#357B42;font-style:italic;"># 用户清单</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_permissions</span><span style="color:#002339;"> </span><span style="color:#174781;">-p</span><span style="color:#002339;"> </span><span style="color:#A44185;">/</span><span style="color:#002339;"> </span><span style="color:#A44185;">用户名</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;.*&quot;</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;.*&quot;</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;.*&quot;</span><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;"># 授权</span></span></code></pre></div><h3 id="rabbitmq的角色分类" tabindex="-1">RabbitMQ的角色分类 <a class="header-anchor" href="#rabbitmq的角色分类" aria-label="Permalink to &quot;RabbitMQ的角色分类&quot;">​</a></h3><ol><li><span style="color:rgb(83, 29, 171);">None </span> 不能访问management plugin</li><li><span style="color:rgb(83, 29, 171);">Management </span>查看自己相关节点信息 <ol><li>列出自己可以通过AMQP登录的虚拟机</li><li>查看自己的虚拟机节点 virtual hosts的queues，exchanges和bindings信息</li><li>查看和关闭自己的channels和connections</li><li>查看有关自己的虚拟机节点virtual hosts的统计信息 包括其他用户在这个节点virtual hosts中的活动信息</li></ol></li><li><span style="color:rgb(83, 29, 171);">Policymaker </span><ol><li>包含management所以权限</li><li>查看和创建和删除自己的virtual hosts所属的policies和parameters信息</li></ol></li><li><span style="color:rgb(83, 29, 171);">Monitoring </span><ol><li>包含management所以权限</li><li>罗列出所有的virtual hosts 包括不能登录的virtual hosts</li><li>查看其他用户的connection和channels信息</li><li>查看节点级别的数据如clustering和memory使用情况</li><li>查看所有的virtual hosts的全局统计信息</li></ol></li><li><span style="color:rgb(83, 29, 171);">Administrator </span><ol><li>最高权限</li><li>可以创建和删除virtual hosts</li><li>可以查看和删除users</li><li>查看和创建permissions</li></ol></li></ol><p><img src="/doc/mq/img-12.png" alt="image.png"></p><h3 id="简单demo示例" tabindex="-1">简单Demo示例 <a class="header-anchor" href="#简单demo示例" aria-label="Permalink to &quot;简单Demo示例&quot;">​</a></h3><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">&lt;!--  java原生依赖   --&gt;</span></span>
<span class="line"><span style="color:#002339;"> &lt;</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;com.rabbitmq&lt;/</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;amqp-client&lt;/</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">version</span><span style="color:#002339;">&gt;5.10.0&lt;/</span><span style="color:#0444AC;">version</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;/</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">&lt;!--  spring依赖   --&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;org.springframework.amqp&lt;/</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;spring-amqp&lt;/</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">version</span><span style="color:#002339;">&gt;2.2.5.RELEASE&lt;/</span><span style="color:#0444AC;">version</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;/</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;org.springframework.amqp&lt;/</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;spring-rabbit&lt;/</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">version</span><span style="color:#002339;">&gt;2.2.5.RELEASE&lt;/</span><span style="color:#0444AC;">version</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;/</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">&lt;!--  springboot依赖   --&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;org.springframework.boot&lt;/</span><span style="color:#0444AC;">groupId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">   &lt;</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;spring-boot-starter-amqp&lt;/</span><span style="color:#0444AC;">artifactId</span><span style="color:#002339;">&gt;</span></span>
<span class="line"><span style="color:#002339;">&lt;/</span><span style="color:#0444AC;">dependency</span><span style="color:#002339;">&gt;</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"> * 生产者</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">Producer</span><span style="color:#002339;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">static</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">main</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;">[] </span><span style="color:#B1108E;">args</span><span style="color:#002339;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 所有的中间件都是基于TCP/IP协议基础上构建，只不过rabbitmq遵循amqp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 1 创建连接</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">ConnectionFactory</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;">  </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ConnectionFactory</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setHost</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;42.193.102.182&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setPort</span><span style="color:#002339;">(</span><span style="color:#174781;">5672</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setUsername</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;admin&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setPassword</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;admin&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setVirtualHost</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;/&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">Connection</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 2 创建Connection</span></span>
<span class="line"><span style="color:#002339;">            connection </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">newConnection</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;生成者&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 3 获取通道Channel</span></span>
<span class="line"><span style="color:#002339;">            channel </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;">.</span><span style="color:#7EB233;">createChannel</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 4 通过通道创建交换机、队列、绑定关系、路由key、发送消息和接收消息</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">queueName</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;queue1&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">             * @params1 队列的名字</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">             * @params2 是否要持久化 消息是否存盘</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">             * @params3 排他性 是否独占独立</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">             * @params4 是否自动删除，随着最后一个消费者消息完毕以后是否队列删除</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">             * @params5 附加参数</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">             */</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">queueDeclare</span><span style="color:#002339;">(queueName,</span><span style="color:#174781;">false</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">,</span><span style="color:#174781;">null</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 5 准备消息</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">message</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;Hello world&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 6 发送消息给队列</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">basicPublish</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;&quot;</span><span style="color:#002339;">,queueName,</span><span style="color:#174781;">null</span><span style="color:#002339;">,</span><span style="color:#2F86D2;">message</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getBytes</span><span style="color:#002339;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> | </span><span style="color:#0991B6;">TimeoutException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">printStackTrace</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 7 关闭连接</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (channel </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isOpen</span><span style="color:#002339;">()){</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Exception</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">printStackTrace</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 8 关闭通道</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (connection </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isOpen</span><span style="color:#002339;">()){</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">printStackTrace</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"> * 消费者</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">Consumer</span><span style="color:#002339;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">static</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">main</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;">[] </span><span style="color:#B1108E;">args</span><span style="color:#002339;">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 所有的中间件都是基于TCP/IP协议基础上构建，只不过rabbitmq遵循amqp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#357B42;font-style:italic;">// 1 创建连接</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">ConnectionFactory</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;">  </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">ConnectionFactory</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setHost</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;42.193.102.182&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setPort</span><span style="color:#002339;">(</span><span style="color:#174781;">5672</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setUsername</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;admin&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setPassword</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;admin&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">setVirtualHost</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;/&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">Connection</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#0991B6;">Channel</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 2 创建Connection</span></span>
<span class="line"><span style="color:#002339;">            connection </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connectionFactory</span><span style="color:#002339;">.</span><span style="color:#7EB233;">newConnection</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;生成者&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 3 获取通道Channel</span></span>
<span class="line"><span style="color:#002339;">            channel </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;">.</span><span style="color:#7EB233;">createChannel</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 4 通过通道创建交换机、队列、绑定关系、路由key、发送消息和接收消息</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">basicConsume</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;queue1&quot;</span><span style="color:#002339;">, </span><span style="color:#174781;">true</span><span style="color:#002339;">, </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">DeliverCallback</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">                @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">handle</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#B1108E;">consumerTag</span><span style="color:#002339;">, </span><span style="color:#0991B6;">Delivery</span><span style="color:#002339;"> </span><span style="color:#B1108E;">message</span><span style="color:#002339;">) </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;收到的消息是&quot;</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">+</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">String</span><span style="color:#002339;">(</span><span style="color:#2F86D2;">message</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getBody</span><span style="color:#002339;">(), </span><span style="color:#2F86D2;">StandardCharsets</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">UTF_8</span><span style="color:#002339;">));</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }, </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">CancelCallback</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">                @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">handle</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#B1108E;">s</span><span style="color:#002339;">) </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;接收失败......&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            });</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;开始接收消息&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">in</span><span style="color:#002339;">.</span><span style="color:#7EB233;">read</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> | </span><span style="color:#0991B6;">TimeoutException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">printStackTrace</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">        } </span><span style="color:#7B30D0;">finally</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 7 关闭连接</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (channel </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isOpen</span><span style="color:#002339;">()){</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">channel</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">Exception</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">printStackTrace</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#357B42;font-style:italic;">// 8 关闭通道</span></span>
<span class="line"><span style="color:#002339;">            </span><span style="color:#7B30D0;">if</span><span style="color:#002339;"> (connection </span><span style="color:#7B30D0;">!=</span><span style="color:#002339;"> </span><span style="color:#174781;">null</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&amp;&amp;</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;">.</span><span style="color:#7EB233;">isOpen</span><span style="color:#002339;">()){</span></span>
<span class="line"><span style="color:#002339;">                </span><span style="color:#7B30D0;">try</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">connection</span><span style="color:#002339;">.</span><span style="color:#7EB233;">close</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                } </span><span style="color:#7B30D0;">catch</span><span style="color:#002339;"> (</span><span style="color:#0991B6;">IOException</span><span style="color:#002339;"> </span><span style="color:#B1108E;">e</span><span style="color:#002339;">) {</span></span>
<span class="line"><span style="color:#002339;">                    </span><span style="color:#2F86D2;">e</span><span style="color:#002339;">.</span><span style="color:#7EB233;">printStackTrace</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">                }</span></span>
<span class="line"><span style="color:#002339;">            }</span></span>
<span class="line"><span style="color:#002339;">        }</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h3 id="amqp-1" tabindex="-1">AMQP <a class="header-anchor" href="#amqp-1" aria-label="Permalink to &quot;AMQP&quot;">​</a></h3><p>AMQP生产者流转过程</p><p><img src="/doc/mq/img-13.png" alt="image.png"></p><p>消费者流转过程</p><p><img src="/doc/mq/img-14.png" alt="image.png"></p><h3 id="rabbitmq的核心组成部分" tabindex="-1">RabbitMQ的核心组成部分 <a class="header-anchor" href="#rabbitmq的核心组成部分" aria-label="Permalink to &quot;RabbitMQ的核心组成部分&quot;">​</a></h3><p><img src="/doc/mq/img-15.png" alt="image.png"><img src="/doc/mq/img-16.png" alt="image.png"></p><ul><li><span style="color:rgb(83, 29, 171);">Server </span>又称Broker，接收客户端的连接，实现AMQP实体服务，按照rabbitmq-server</li><li><span style="color:rgb(83, 29, 171);">Connection </span> 连接，应用程序与Broker的网络连接 TCP/IP 三次握手和四次握手</li><li><span style="color:rgb(83, 29, 171);">Channl </span> 网络通道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的通道，客户端可以建立对</li></ul><p>各Channel，每个Channel代表一个会话任务</p><ul><li><p>Message 消息，服务与应用程序之间传递的数据，由Properties和body组成，Properties可是对消息进行修饰</p><p>比较消息的优先级，延迟等高特性，Body则就是消息实体的内容</p></li><li><p>Virtual Host 虚拟地址，用户进行逻辑隔离，最上层的消息路由，一个虚拟主机理由可以有若干个 Exchange和</p></li></ul><p>Queueu，同一个虚拟主机里面不能有相同名字的 Exchange</p><ul><li><span style="color:rgb(83, 29, 171);">Exchange </span> 交换机，接收消息，根据路由键发送消息到绑定的队列（不具备消息存储的功能）</li><li><span style="color:rgb(83, 29, 171);">Bindings </span> Exchange和Queue之间的虚拟连接，bingding中可以保护多个routing key</li><li><span style="color:rgb(83, 29, 171);">Routing key </span> 是一个路由规则，虚拟机可以用它来确定如何路由一个特定消息</li><li><span style="color:rgb(83, 29, 171);">Queue </span> 队列，也成为Messgae Queue消息队列，保存消息并将它们转发给消费者</li></ul><h3 id="消息模式" tabindex="-1">消息模式 <a class="header-anchor" href="#消息模式" aria-label="Permalink to &quot;消息模式&quot;">​</a></h3><p><a href="https://rabbitmq.com/getstarted.html" target="_blank" rel="noreferrer">官方文档</a></p><p>简单模式 Simple，参考上述的demo示例</p><p>工作模式 Work</p><p><img src="/doc/mq/img-17.png" alt="image.png"></p><p>发布订阅模式 Fanout</p><p><img src="/doc/mq/img-18.png" alt="image.png"></p><p>路由模式 direct</p><p><img src="/doc/mq/img-19.png" alt="image.png"></p><p>主题模式 Topic</p><p><img src="/doc/mq/img-20.png" alt="image.png"></p><p>参数模式 Headers</p><p>RPC模式</p><h3 id="应用场景-1" tabindex="-1">应用场景 <a class="header-anchor" href="#应用场景-1" aria-label="Permalink to &quot;应用场景&quot;">​</a></h3><h4 id="解耦、削峰、异步" tabindex="-1">解耦、削峰、异步 <a class="header-anchor" href="#解耦、削峰、异步" aria-label="Permalink to &quot;解耦、削峰、异步&quot;">​</a></h4><p>1- 同步异步的问题（串行）</p><div class="tip custom-block"><p class="custom-block-title">串行方式</p><p>将订单信息写入数据库成功后，发送注册邮件，再发送注册短信，以上三个任务全部完成后返回客户端</p></div><p><img src="/doc/mq/img-21.png" alt="image.png"></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">makerOrder</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#357B42;font-style:italic;">// 1 保存订单</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">orderService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">saveOrder</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 2 发送短信服务</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">messageService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendSMS</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;oreder&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 3 发送邮件</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">emailService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendEmail</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;oreder&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 4 发送APP服务</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">appService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendApp</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;order&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>2- 并行方式 异步线程池</p><p><img src="/doc/mq/img-22.png" alt="image.png"></p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">makeOrder</span><span style="color:#002339;">(){</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#357B42;font-style:italic;">// 保存订单</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">orderService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">saveOrder</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 相关发送</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#7EB233;">ralationMessage</span><span style="color:#002339;">();</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">relationMessage</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">	</span><span style="color:#357B42;font-style:italic;">// 异步</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">theadpool</span><span style="color:#002339;">.</span><span style="color:#7EB233;">submit</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Callable</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt;{</span></span>
<span class="line"><span style="color:#002339;">  		</span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#7EB233;">call</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">      	</span><span style="color:#357B42;font-style:italic;">// 发送短信</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">messageService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendSMS</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;oreder&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">      }</span></span>
<span class="line"><span style="color:#002339;">  })</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 异步</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">theadpool</span><span style="color:#002339;">.</span><span style="color:#7EB233;">submit</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Callable</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt;{</span></span>
<span class="line"><span style="color:#002339;">  		</span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#7EB233;">call</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">      	</span><span style="color:#357B42;font-style:italic;">// 发送邮件</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">emailService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendEmail</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;oreder&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">      }</span></span>
<span class="line"><span style="color:#002339;">  })</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 异步</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">theadpool</span><span style="color:#002339;">.</span><span style="color:#7EB233;">submit</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Callable</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt;{</span></span>
<span class="line"><span style="color:#002339;">  		</span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#7EB233;">call</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">      	</span><span style="color:#357B42;font-style:italic;">// 发送短信</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">messageService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendSMS</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;oreder&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">      }</span></span>
<span class="line"><span style="color:#002339;">  })</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">// 异步</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#2F86D2;">theadpool</span><span style="color:#002339;">.</span><span style="color:#7EB233;">submit</span><span style="color:#002339;">(</span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Callable</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt;{</span></span>
<span class="line"><span style="color:#002339;">  		</span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Object</span><span style="color:#002339;"> </span><span style="color:#7EB233;">call</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">      	</span><span style="color:#357B42;font-style:italic;">// 发送APP服务</span></span>
<span class="line"><span style="color:#002339;">  			</span><span style="color:#2F86D2;">appService</span><span style="color:#002339;">.</span><span style="color:#7EB233;">sendApp</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;order&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">      }</span></span>
<span class="line"><span style="color:#002339;">  })</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><p>存在问题 ：</p><ul><li>耦合度高</li><li>需要自己写线程自己维护成本高</li><li>出现了消息可能会丢失，需要你自己做消息补偿</li><li>如何保证消息的可靠性自己写</li><li>如果服务器承载不了，需要自己去写高可用</li></ul><p>3- 异步消息队列</p><p><img src="/doc/mq/img-23.png" alt="image.png"></p><p>好处</p><ul><li>完全解耦，用MQ建立桥接</li><li>有独立的线程池和运行模型</li><li>出现了消息可能丢失，MQ有持久化</li><li>如何保证消息的可靠性，死信队列和消息转移等</li><li>如果服务器承载不了，你需要自己去写高可用，HA镜像模型高可用</li></ul><h4 id="高内聚、低耦合" tabindex="-1">高内聚、低耦合 <a class="header-anchor" href="#高内聚、低耦合" aria-label="Permalink to &quot;高内聚、低耦合&quot;">​</a></h4><p><img src="/doc/mq/img-24.png" alt="image.png"></p><h4 id="其他应用" tabindex="-1">其他应用 <a class="header-anchor" href="#其他应用" aria-label="Permalink to &quot;其他应用&quot;">​</a></h4><ul><li>流量削峰</li><li>分布式事务的可靠消费和可靠生成</li><li>索引、缓存、静态化处理的数据同步</li><li>流量监控</li><li>日志监控 ELK</li><li>下单、订单分发、抢票</li></ul><h3 id="springboot-案例" tabindex="-1">SpringBoot 案例 <a class="header-anchor" href="#springboot-案例" aria-label="Permalink to &quot;SpringBoot 案例&quot;">​</a></h3><h4 id="fanout模式" tabindex="-1">fanout模式 <a class="header-anchor" href="#fanout模式" aria-label="Permalink to &quot;fanout模式&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Configuration</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">RabbitMqConfig</span><span style="color:#002339;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 声明注册fanout模式交换机</span></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">FanoutExchange</span><span style="color:#002339;"> </span><span style="color:#7EB233;">fanoutExchange</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">FanoutExchange</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;fanout_order_exchange&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 声明队列 sms</span></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Queue</span><span style="color:#002339;"> </span><span style="color:#7EB233;">smsQueue</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Queue</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;sms.fanout.queue&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#357B42;font-style:italic;">// 绑定关系</span></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Binding</span><span style="color:#002339;"> </span><span style="color:#7EB233;">smsBinding</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">  </span><span style="color:#2F86D2;">BindingBuilder</span><span style="color:#002339;">.</span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(</span><span style="color:#7EB233;">smsQueue</span><span style="color:#002339;">()).</span><span style="color:#7EB233;">to</span><span style="color:#002339;">(</span><span style="color:#7EB233;">fanoutExchange</span><span style="color:#002339;">());</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Autowired</span></span>
<span class="line"><span style="color:#DA5221;">private</span><span style="color:#002339;"> </span><span style="color:#0991B6;">RabbitTemplate</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">rabbitTemplate</span><span style="color:#002339;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 参数1 交换机 参数2 路由key、queue名称 参数3 消息内容</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">exchangeName</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;fanout_order_exchange&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">routeKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#2F86D2;">rabbitTemplate</span><span style="color:#002339;">.</span><span style="color:#7EB233;">convertAndSend</span><span style="color:#002339;">(exchangeName,routeKey,orderId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Component</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">RabbitListener</span><span style="color:#002339;">(</span><span style="color:#174781;">queues</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> {</span><span style="color:#A44185;">&quot;sms.fanout.queue&quot;</span><span style="color:#002339;">})</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">ConsumerService</span><span style="color:#002339;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">RabbitHandler</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">receiveMessage</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#B1108E;">message</span><span style="color:#002339;">){</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;短信接收 ----&gt;&quot;</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">+</span><span style="color:#002339;"> message );</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h4 id="direct模式" tabindex="-1">direct模式 <a class="header-anchor" href="#direct模式" aria-label="Permalink to &quot;direct模式&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 声明注册fanout模式交换机</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">DirectExchange</span><span style="color:#002339;"> </span><span style="color:#7EB233;">directExchange</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">DirectExchange</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;direct_order_exchange&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 声明队列 sms</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Queue</span><span style="color:#002339;"> </span><span style="color:#7EB233;">smsQueue</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Queue</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;sms.direct.queue&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 绑定关系</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Binding</span><span style="color:#002339;"> </span><span style="color:#7EB233;">smsBinding</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">  </span><span style="color:#2F86D2;">BindingBuilder</span><span style="color:#002339;">.</span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(</span><span style="color:#7EB233;">smsQueue</span><span style="color:#002339;">()).</span><span style="color:#7EB233;">to</span><span style="color:#002339;">(</span><span style="color:#7EB233;">directExchange</span><span style="color:#002339;">()).</span><span style="color:#7EB233;">with</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;sms&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 参数1 交换机 参数2 路由key、queue名称 参数3 消息内容</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">exchangeName</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;direct_order_exchange&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">routeKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;sms&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#2F86D2;">rabbitTemplate</span><span style="color:#002339;">.</span><span style="color:#7EB233;">convertAndSend</span><span style="color:#002339;">(exchangeName,routeKey,orderId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Component</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">RabbitListener</span><span style="color:#002339;">(</span><span style="color:#174781;">queues</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> {</span><span style="color:#A44185;">&quot;sms.direct.queue&quot;</span><span style="color:#002339;">})</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">ConsumerService</span><span style="color:#002339;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">RabbitHandler</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">receiveMessage</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#B1108E;">message</span><span style="color:#002339;">){</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;短信接收 ----&gt;&quot;</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">+</span><span style="color:#002339;"> message );</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><h4 id="topic模式" tabindex="-1">topic模式 <a class="header-anchor" href="#topic模式" aria-label="Permalink to &quot;topic模式&quot;">​</a></h4><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Component</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">RabbitListener</span><span style="color:#002339;">(</span><span style="color:#174781;">bindings</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> @</span><span style="color:#0991B6;">QueueBinding</span><span style="color:#002339;">(</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#174781;">value</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> @</span><span style="color:#0991B6;">Queue</span><span style="color:#002339;">(</span><span style="color:#174781;">value</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;sms.topic.queue&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">durable</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;true&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">autoDelete</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;false&quot;</span><span style="color:#002339;">),</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#174781;">exchange</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> @</span><span style="color:#0991B6;">Exchange</span><span style="color:#002339;">(</span><span style="color:#174781;">value</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;topic_order_exchange&quot;</span><span style="color:#002339;"> , </span><span style="color:#174781;">type</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">ExchangeTypes</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">TOPIC</span><span style="color:#002339;">),</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#174781;">key</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;#.sms.#&quot;</span></span>
<span class="line"><span style="color:#002339;">))</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#DA5221;">class</span><span style="color:#002339;"> </span><span style="color:#0444AC;">ConsumerService</span><span style="color:#002339;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">RabbitHandler</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">void</span><span style="color:#002339;"> </span><span style="color:#7EB233;">receiveMessage</span><span style="color:#002339;">(</span><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#B1108E;">message</span><span style="color:#002339;">){</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">System</span><span style="color:#002339;">.</span><span style="color:#2F86D2;">out</span><span style="color:#002339;">.</span><span style="color:#7EB233;">println</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;短信接收 ----&gt;&quot;</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">+</span><span style="color:#002339;"> message );</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 参数1 交换机 参数2 路由key、queue名称 参数3 消息内容</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">exchangeName</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;topic_order_exchange&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// #.sms.#</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">routeKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;com.sms&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#2F86D2;">rabbitTemplate</span><span style="color:#002339;">.</span><span style="color:#7EB233;">convertAndSend</span><span style="color:#002339;">(exchangeName,routeKey,orderId);</span></span></code></pre></div><h3 id="高级应用" tabindex="-1">高级应用 <a class="header-anchor" href="#高级应用" aria-label="Permalink to &quot;高级应用&quot;">​</a></h3><h4 id="过期时间-ttl" tabindex="-1">过期时间 TTL <a class="header-anchor" href="#过期时间-ttl" aria-label="Permalink to &quot;过期时间 TTL&quot;">​</a></h4><p>过期时间TTL表示可以对消息设置预期时间，在这个时间内都可以被消费者接收获取，过了之后消息将自动删除， RabbitMQ可以对 消息队列 设置TTL，目前有两种方法可以设置</p><ul><li>通过队列属性设置，队列中所以消息都有相同的过期时间</li><li>对消息进行单独设置，每条消息TTL可不同</li></ul><p>如果上述两种方式同时使用，则消息的过期时间以两者之间TTL较小的数值为准，消息在队列的生成时间一旦超过设置的TTL值，就称为dead message被投递到死信队列，消费者将吴凡再收到消息</p><p>设置队列TTL</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 对队列设置过期时间</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 设置过期时间 5秒</span></span>
<span class="line"><span style="color:#0991B6;">Map</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">String</span><span style="color:#002339;">,</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt; </span><span style="color:#2F86D2;">args</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">HashMap</span><span style="color:#002339;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#2F86D2;">args</span><span style="color:#002339;">.</span><span style="color:#7EB233;">put</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;x-message-ttl&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">5000</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Queue</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;ttl.direct.queue&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">,args);</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 给单独一条消息设置过期时间</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">exchangeName</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;ttl_direct_order_exchange&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#0991B6;">String</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">routeKey</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#A44185;">&quot;ttl&quot;</span><span style="color:#002339;">;</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 设置过期时间</span></span>
<span class="line"><span style="color:#0991B6;">MessagePostProcessor</span><span style="color:#002339;"> </span><span style="color:#2F86D2;">processor</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">MessagePostProcessor</span><span style="color:#002339;">() {</span></span>
<span class="line"><span style="color:#002339;">    @</span><span style="color:#0991B6;">Override</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Message</span><span style="color:#002339;"> </span><span style="color:#7EB233;">postProcessMessage</span><span style="color:#002339;">(</span><span style="color:#0991B6;">Message</span><span style="color:#002339;"> </span><span style="color:#B1108E;">message</span><span style="color:#002339;">) </span><span style="color:#DA5221;">throws</span><span style="color:#002339;"> </span><span style="color:#0991B6;">AmqpException</span><span style="color:#002339;"> {</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">message</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getMessageProperties</span><span style="color:#002339;">().</span><span style="color:#7EB233;">setExpiration</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;5000&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#2F86D2;">message</span><span style="color:#002339;">.</span><span style="color:#7EB233;">getMessageProperties</span><span style="color:#002339;">().</span><span style="color:#7EB233;">setContentEncoding</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;UTF-8&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">        </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> message;</span></span>
<span class="line"><span style="color:#002339;">    }</span></span>
<span class="line"><span style="color:#002339;">};</span></span>
<span class="line"><span style="color:#2F86D2;">rabbitTemplate</span><span style="color:#002339;">.</span><span style="color:#7EB233;">convertAndSend</span><span style="color:#002339;">(exchangeName,routeKey,</span><span style="color:#A44185;">&quot;&quot;</span><span style="color:#002339;">,processor);</span></span></code></pre></div><h4 id="死信队列" tabindex="-1">死信队列 <a class="header-anchor" href="#死信队列" aria-label="Permalink to &quot;死信队列&quot;">​</a></h4><p>DLX，全称 Dead-Letter-Exchange ，可以称为死信交换机，当消息在一个队列中变成死信之后，它能被重新发送到另一个交换机中，这个交换机接收DLX，绑定DLX的队列就称为死信队列</p><ul><li>消息被拒绝</li><li>消息过期</li><li>队列达到最大长度</li></ul><p>DLX也是一个正常的交换机，它能在任何的队列上被指定，实际上就是设置某一个队列的属性，当这个队列存在死信的时候，RabbitMQ就会自己讲这个消息重新发布到设置的DLX上，进而被路由到另一个队列，即死信队列 要想使用死信队列，只需要在定义队列的时候设置队列参数， x-dead-letter-exchange 指定交换机即可</p><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 声明注册死信交换机</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">DirectExchange</span><span style="color:#002339;"> </span><span style="color:#7EB233;">DLXExchange</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">DirectExchange</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;dead_direct_order_exchange&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 声明死信队列 sms</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Queue</span><span style="color:#002339;"> </span><span style="color:#7EB233;">smsQueue</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Queue</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;dead.direct.queue&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 绑定关系</span></span>
<span class="line"><span style="color:#002339;">@</span><span style="color:#0991B6;">Bean</span></span>
<span class="line"><span style="color:#DA5221;">public</span><span style="color:#002339;"> </span><span style="color:#0991B6;">Binding</span><span style="color:#002339;"> </span><span style="color:#7EB233;">dxlBinding</span><span style="color:#002339;">(){</span></span>
<span class="line"><span style="color:#002339;">    </span><span style="color:#7B30D0;">return</span><span style="color:#002339;">  </span><span style="color:#2F86D2;">BindingBuilder</span><span style="color:#002339;">.</span><span style="color:#7EB233;">bind</span><span style="color:#002339;">(</span><span style="color:#7EB233;">smsQueue</span><span style="color:#002339;">()).</span><span style="color:#7EB233;">to</span><span style="color:#002339;">(</span><span style="color:#7EB233;">DLXExchange</span><span style="color:#002339;">()).</span><span style="color:#7EB233;">with</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;dxl&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#002339;">}</span></span></code></pre></div><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;">// 设置过期时间 5秒</span></span>
<span class="line"><span style="color:#0991B6;">Map</span><span style="color:#002339;">&lt;</span><span style="color:#0991B6;">String</span><span style="color:#002339;">,</span><span style="color:#0991B6;">Object</span><span style="color:#002339;">&gt; </span><span style="color:#2F86D2;">args</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">=</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#0991B6;">HashMap</span><span style="color:#002339;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#2F86D2;">args</span><span style="color:#002339;">.</span><span style="color:#7EB233;">put</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;x-message-ttl&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">5000</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#2F86D2;">args</span><span style="color:#002339;">.</span><span style="color:#7EB233;">put</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;x-mxa-length&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">1</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// 指定死信队列</span></span>
<span class="line"><span style="color:#2F86D2;">args</span><span style="color:#002339;">.</span><span style="color:#7EB233;">put</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;x-dead-letter-exchange&quot;</span><span style="color:#002339;">,</span><span style="color:#A44185;">&quot;dead_direct_order_exchange&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;">// fanout 模式是没有的</span></span>
<span class="line"><span style="color:#2F86D2;">args</span><span style="color:#002339;">.</span><span style="color:#7EB233;">put</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;x-dead-letter-routing-key&quot;</span><span style="color:#002339;">,</span><span style="color:#A44185;">&quot;dxl&quot;</span><span style="color:#002339;">);</span></span>
<span class="line"><span style="color:#7B30D0;">return</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">new</span><span style="color:#002339;"> </span><span style="color:#7EB233;">Queue</span><span style="color:#002339;">(</span><span style="color:#A44185;">&quot;ttl.direct.queue&quot;</span><span style="color:#002339;">,</span><span style="color:#174781;">true</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">,</span><span style="color:#174781;">false</span><span style="color:#002339;">,args);</span></span></code></pre></div><h4 id="磁盘监控" tabindex="-1">磁盘监控 <a class="header-anchor" href="#磁盘监控" aria-label="Permalink to &quot;磁盘监控&quot;">​</a></h4><p>内存警告</p><p>当内存使用超过配置的阀值或者磁盘空间剩余空间对于配置的阀值时，会暂时堵塞客户端的连接，并且停止接收从客户端发来的消息，以此避免服务器的崩溃，客户端与服务端的心态检测机制也会失效</p><p><img src="/doc/mq/img-25.png" alt="image.png"><img src="/doc/mq/img-26.png" alt="image.png"></p><p>内存的控制 <a href="https://rabbitmq.com/config.html" target="_blank" rel="noreferrer">参考文档</a></p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;"># 命令 两种方式</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_vm_memory_high_watermark</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&lt;</span><span style="color:#A44185;">fractio</span><span style="color:#002339;">n</span><span style="color:#7B30D0;">&gt;</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_vm_memory_high_watermark</span><span style="color:#002339;"> </span><span style="color:#A44185;">absolute</span><span style="color:#002339;"> </span><span style="color:#174781;">50</span><span style="color:#A44185;">MB</span></span></code></pre></div><p>fraction/value 为内存阀值，默认情况是：0.4/2GB，代表当内存超过40%的时候，就会产生警告并且堵塞所以生产者的连接，通过命令修改阀值在Broker重启以后将会失效，通过修改配置文件方式设置的阀值则不会随着重启而消失，但修改了配置文件一样要重启broker才会生效</p><p>使用配置文件进行控制</p><blockquote><p>/etc/rabbitmq/rabbitmq.conf</p></blockquote><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;"># 默认</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># vm_memory_high_watermark.relative = 0.4</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 使用relative相对值进行设置fraction，建议取值在0.4~0.7之间，不建议超过0.7</span></span>
<span class="line"><span style="color:#7EB233;">vm_memory_high_watermark.relative</span><span style="color:#002339;"> </span><span style="color:#A44185;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">0.6</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 使用absolute的绝对值的方式，但是是KB、MB、GB对应的命令如下</span></span>
<span class="line"><span style="color:#7EB233;">vm_memory_high_watermark.absolute</span><span style="color:#002339;"> </span><span style="color:#A44185;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">2</span><span style="color:#A44185;">GB</span></span></code></pre></div><p>内存换页 磁盘预警</p><p>当磁盘的剩余空间低于确定的阀值时，RabbitMQ同样会堵塞生产者，这样可以避免因非持久化的消息持续换页而耗尽磁盘空间导致服务器崩溃</p><div class="tip custom-block"><p class="custom-block-title">提示</p><p>默认情况下，磁盘预警为50MB的时候会进行预警，堵塞生产者，这个阀值可以减小，但是不能完全的消除因磁盘耗尽而导致崩溃的可能性，比如在两次磁盘空间的检查空隙内，第一次检查是 60MB，第二次检查可能就是1MB，就会出现警告</p></div><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_disk_free_limit</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&lt;</span><span style="color:#A44185;">disk_limi</span><span style="color:#002339;">t</span><span style="color:#7B30D0;">&gt;</span></span>
<span class="line"><span style="color:#7EB233;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">set_disk_free_limit_memory_limit</span><span style="color:#002339;"> </span><span style="color:#7B30D0;">&lt;</span><span style="color:#A44185;">fractio</span><span style="color:#002339;">n</span><span style="color:#7B30D0;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7EB233;">disk_limit：</span><span style="color:#002339;"> </span><span style="color:#A44185;">固定单位</span><span style="color:#002339;"> </span><span style="color:#A44185;">KM</span><span style="color:#002339;"> </span><span style="color:#A44185;">MB</span><span style="color:#002339;"> </span><span style="color:#A44185;">GB</span></span>
<span class="line"><span style="color:#7EB233;">fraction:</span><span style="color:#002339;"> </span><span style="color:#A44185;">是相对阀值，建议范围在:</span><span style="color:#002339;"> </span><span style="color:#174781;">1.0</span><span style="color:#A44185;">~2.0之间</span><span style="color:#002339;"> </span><span style="color:#A44185;">（相对于内存）</span></span></code></pre></div><p>通过配置文件配置如下:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">disk_free_limit.relative</span><span style="color:#002339;"> </span><span style="color:#A44185;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">3.0</span></span>
<span class="line"><span style="color:#7EB233;">disk_free_limit.absolute</span><span style="color:#002339;"> </span><span style="color:#A44185;">=</span><span style="color:#002339;"> </span><span style="color:#174781;">50</span><span style="color:#A44185;">mb</span></span></code></pre></div><h3 id="集群搭建" tabindex="-1">集群搭建 <a class="header-anchor" href="#集群搭建" aria-label="Permalink to &quot;集群搭建&quot;">​</a></h3><p>配置前提是你的rabbitmq可以运行起来，比如&quot;ps aux|grep rabbitmq&quot; 你能看到相关过程，又比如运行&quot;rabbitmqctl status&quot; 你可以看到类似如下信息，而不报错</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">ps</span><span style="color:#002339;"> </span><span style="color:#A44185;">aux</span><span style="color:#7B30D0;">|</span><span style="color:#7EB233;">grep</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 或者使用</span></span>
<span class="line"><span style="color:#7EB233;">systemctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">status</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq-server</span></span></code></pre></div><p><img src="/doc/mq/img-27.png" alt="image.png"></p><div class="warning custom-block"><p class="custom-block-title">注意</p><p>确保RabbitMQ可以运行，把单机版MQ服务停止</p></div><h4 id="单机多实例搭建" tabindex="-1">单机多实例搭建 <a class="header-anchor" href="#单机多实例搭建" aria-label="Permalink to &quot;单机多实例搭建&quot;">​</a></h4><ul><li>场景：假如有两个mq节点，分别为rabit-1、rabbit-2，rabbit-1为主节点，rabbit-2为从节点</li><li>启动命令： RABBITMQ_NODE_PORT=5672 RABBIYMQ_NODENAME=rabbit-1 rabbitmq-server -detached</li><li>结束命令： rabbitmqctl -n rabbit-1 stop</li></ul><p>第一步 启动第一个节点</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;">sudo RABBITMQ_NODE_PORT=5672 RABBIYMQ_NODENAME=rabbit-1 rabbitmq-server start &amp;</span></span>
<span class="line"><span style="color:#002339;">  </span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#7EB233;">----------省略---------</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">######## Logs: /var/log/rabbitmq/rabbit-1.log</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">#####  #       /var/log/rabbitmq/rabbit-1-sasl.log</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">########</span></span>
<span class="line"><span style="color:#002339;">  				 </span><span style="color:#7EB233;">Starting</span><span style="color:#002339;"> </span><span style="color:#A44185;">broker...</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#7EB233;">completed</span><span style="color:#002339;"> </span><span style="color:#A44185;">with</span><span style="color:#002339;"> </span><span style="color:#174781;">7</span><span style="color:#002339;"> </span><span style="color:#A44185;">plugins.</span></span></code></pre></div><p>第二步 启动第二个节点</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;">sudo RABBITMQ_NODE_PORT=5672 RABBIYMQ_SERVER_ARGS=</span><span style="color:#A44185;">&quot;-rabbitmq_management listener[{port,15673}]&quot;</span><span style="color:#002339;"> RABBITMQ_NODENAME=rabbit-2 rabbitmq-server start &amp;</span></span>
<span class="line"><span style="color:#002339;">  </span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#7EB233;">----------省略---------</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">######## Logs: /var/log/rabbitmq/rabbit-2.log</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">#####  #       /var/log/rabbitmq/rabbit-2-sasl.log</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#357B42;font-style:italic;">########</span></span>
<span class="line"><span style="color:#002339;">  				 </span><span style="color:#7EB233;">Starting</span><span style="color:#002339;"> </span><span style="color:#A44185;">broker...</span></span>
<span class="line"><span style="color:#002339;">  </span><span style="color:#7EB233;">completed</span><span style="color:#002339;"> </span><span style="color:#A44185;">with</span><span style="color:#002339;"> </span><span style="color:#174781;">7</span><span style="color:#002339;"> </span><span style="color:#A44185;">plugins.</span></span></code></pre></div><p>第三步 验证启动</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">ps</span><span style="color:#002339;"> </span><span style="color:#A44185;">aux</span><span style="color:#7B30D0;">|</span><span style="color:#7EB233;">grep</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq</span></span></code></pre></div><p>第四步 rabbit-1作为主节点</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;"># 停止服务</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-1 stop_app</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 目的是清除节点上的历史数据(如果不清楚，无法将节点加入到集群)</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-1 reset</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 启动应用</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-1 start_app</span></span></code></pre></div><p>第五步 rabbit-2作为从节点</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#357B42;font-style:italic;"># 停止服务</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-2 stop_app</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 目的是清除节点上的历史数据(如果不清楚，无法将节点加入到集群)</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-2 reset</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 将rabbit-2节点加入到主节点集群当中(Server-node 为主机名称)</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-2 join_cluster rabbit-1@</span><span style="color:#A44185;">&#39;Server-node&#39;</span></span>
<span class="line"><span style="color:#357B42;font-style:italic;"># 启动应用</span></span>
<span class="line"><span style="color:#7B30D0;">&gt;</span><span style="color:#002339;"> sudo rabbitmqctl -n rabbit-2 start_app</span></span></code></pre></div><p><img src="/doc/mq/img-28.png" alt="image.png"></p><p>第六步 验证</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">sudo</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmqctl</span><span style="color:#002339;"> </span><span style="color:#A44185;">cluster_status</span><span style="color:#002339;"> </span><span style="color:#174781;">-n</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbit-1</span></span></code></pre></div><p><img src="/doc/mq/img-29.png" alt="image.png"></p><p><img src="/doc/mq/img-30.png" alt="image.png"></p><p>第七步 WEB监控</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki slack-ochin"><code><span class="line"><span style="color:#7EB233;">rabbitmq-plugins</span><span style="color:#002339;"> </span><span style="color:#A44185;">enable</span><span style="color:#002339;"> </span><span style="color:#A44185;">rabbitmq_management</span></span></code></pre></div><p><img src="/doc/mq/img-31.png" alt="image.png"></p><h4 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h4><p>如果采用多级部署方式，需读取其他一个节点的cookie，并负责到其他节点（节点之间通过cookie确定相互是否可通信）cookie存放在/var/lib/rabbitmq/.erlang.cookie 例如: 主机名为rabbit-1、rabbit-2</p><ul><li>逐个启动各节点</li><li>配置各节点的hosts文件(vim/etc/hosts) <ul><li>ip1：rabbit-1</li><li>ip2：rabbit-2</li></ul></li><li>其他步骤相同</li></ul><h3 id="分布式事务" tabindex="-1">分布式事务 <a class="header-anchor" href="#分布式事务" aria-label="Permalink to &quot;分布式事务&quot;">​</a></h3><p><img src="/doc/mq/img-32.png" alt="image.png"></p><p><img src="/doc/mq/img-33.png" alt="image.png"></p><p><img src="/doc/mq/img-34.png" alt="image.png"></p><p><img src="/doc/mq/img-35.png" alt="image.png"></p><p><img src="/doc/mq/img-36.png" alt="image.png"></p><p><img src="/doc/mq/img-37.png" alt="image.png"></p><p><img src="/doc/mq/img-38.png" alt="image.png"></p></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><div class="edit-info" data-v-ef5dee53><div class="edit-link" data-v-ef5dee53><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/fxbsujay/Sujay-Docs/blob/main/docs/blog/mq.md" target="_blank" rel="noreferrer" data-v-ef5dee53><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-ef5dee53><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 在 GitHub 上编辑此页面<!--]--></a></div><div class="last-updated" data-v-ef5dee53><p class="VPLastUpdated" data-v-ef5dee53 data-v-7de715c0>最近更新时间: <time datetime="2023-05-10T14:16:59.000Z" data-v-7de715c0></time></p></div></div><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/blog/juc.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>上一页</span><span class="title" data-v-ef5dee53>Java JUC</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/blog/elk.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>下一页</span><span class="title" data-v-ef5dee53>ELK 学习文档</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-1919c326 data-v-e03eb2e1><div class="container" data-v-e03eb2e1><p class="message" data-v-e03eb2e1>Released under the <a href="https://github.com/fxbsujay/Sujay-Docs/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-e03eb2e1>Copyright © 2020-present <a href="https://github.com/fxbsujay">Fan XueBin</a> <a href="https://beian.miit.gov.cn/">鲁ICP备2022006050号-1</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blog_hexo.md\":\"a84aa174\",\"blog_css.md\":\"e4763fc2\",\"blog_eventloop.md\":\"471536b1\",\"blog_bit_operation.md\":\"db10f3b8\",\"blog_jdk_support.md\":\"f9931fb7\",\"components_button.md\":\"439755e4\",\"blog_shiwu.md\":\"bd992913\",\"blog_docker.md\":\"cb9c53a8\",\"blog_mysql_index.md\":\"d7e8a110\",\"components_overview.md\":\"4c21adf3\",\"blog_mymap.md\":\"b912d4ee\",\"blog_seata-sharding.md\":\"1375f7d8\",\"index.md\":\"25f20114\",\"blog_text.md\":\"d495ba65\",\"blog_snow-flake.md\":\"8bc954db\",\"blog_vue.md\":\"383b36ee\",\"blog_juc.md\":\"953e4d26\",\"blog_mysql.md\":\"f6ac6a27\",\"blog_redis.md\":\"ac42df03\",\"blog_mq.md\":\"5f8384e8\",\"blog_netty.md\":\"90136efb\",\"blog_elk.md\":\"59399ef9\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Sujay\",\"titleTemplate\":\":title - Sujay\",\"description\":\"Sujay Blog.\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/favicon.ico\",\"siteTitle\":\"Fan Xuebin\",\"outline\":{\"level\":\"deep\",\"label\":\"大纲\"},\"lastUpdated\":{\"text\":\"最近更新时间\"},\"editLink\":{\"pattern\":\"https://github.com/fxbsujay/Sujay-Docs/blob/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页面\"},\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"returnToTopLabel\":\"返回\",\"sidebarMenuLabel\":\"目录\",\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/fxbsujay/Sujay-Docs/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright © 2020-present <a href=\\\"https://github.com/fxbsujay\\\">Fan XueBin</a> <a href=\\\"https://beian.miit.gov.cn/\\\">鲁ICP备2022006050号-1</a>\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/fxbsujay\"}],\"nav\":[{\"text\":\"博客\",\"link\":\"/blog/jdk_support\",\"activeMatch\":\"/blog/\"},{\"text\":\"UI组件库\",\"link\":\"/components/button\",\"activeMatch\":\"/components/\"}],\"sidebar\":{\"/blog\":[{\"text\":\"后端知识库\",\"collapsed\":false,\"items\":[{\"text\":\"JAVA JDK17 新特性\",\"link\":\"/blog/jdk_support\"},{\"text\":\"位运算\",\"link\":\"/blog/bit_operation\"},{\"text\":\"Redis\",\"link\":\"/blog/redis\"},{\"text\":\"Docker\",\"link\":\"/blog/docker\"},{\"text\":\"MySql\",\"link\":\"/blog/mysql\"},{\"text\":\"MySql 索引\",\"link\":\"/blog/mysql_index\"},{\"text\":\"Java JUC\",\"link\":\"/blog/juc\"},{\"text\":\"消息队列\",\"link\":\"/blog/mq\"},{\"text\":\"ELK 学习文档\",\"link\":\"/blog/elk\"},{\"text\":\"Netty 源码分析\",\"link\":\"/blog/netty\"},{\"text\":\"雪花算法\",\"link\":\"/blog/snow-flake\"},{\"text\":\"实现一个简易Map\",\"link\":\"/blog/mymap\"},{\"text\":\"Seata 分布式事务\",\"link\":\"/blog/shiwu\"}]},{\"text\":\"前端知识库\",\"collapsed\":false,\"items\":[{\"text\":\"css选择器\",\"link\":\"/blog/css\"},{\"text\":\"事件循环\",\"link\":\"/blog/eventLoop\"},{\"text\":\"Vue3 快速上手\",\"link\":\"/blog/vue\"}]},{\"text\":\"生活小工具\",\"collapsed\":false,\"items\":[{\"text\":\"使用 Hexo 搭建一个博客\",\"link\":\"/blog/hexo\"},{\"text\":\"示例\",\"link\":\"/blog/text\"}]}],\"/components\":[{\"text\":\"基础组件\",\"collapsed\":false,\"items\":[{\"text\":\"按钮\",\"link\":\"/components/button\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>